<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Lý Nhớ Vũ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 50%, #ffccbc 100%);
            color: #333;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, rgba(198, 40, 40, 0.95) 0%, rgba(183, 28, 28, 0.95) 100%);
            backdrop-filter: blur(10px);
            color: white;
            padding: 25px 0;
            box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }
        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 700;
        }
        .sidebar-user {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            margin-top: auto;
            font-size: 12px;
            opacity: 0.8;
        }
        .sidebar-menu {
            list-style: none;
        }
        .sidebar-menu li {
            margin: 5px 0;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 16px 25px;
            color: rgba(255,255,255,0.95);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0 25px 25px 0;
            margin: 4px 10px;
            font-weight: 500;
        }
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255,255,255,0.2);
            border-left: 5px solid white;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .sidebar-menu i {
            width: 24px;
            margin-right: 12px;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
        }

        /* Header */
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px 35px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .page-header:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .page-header h1 {
            color: #c62828;
            font-size: 28px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .btn-primary {
            background: #c62828;
            color: white;
        }
        .btn-primary:hover {
            background: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(198, 40, 40, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .stat-card:hover::before {
            left: 100%;
        }
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 16px 48px rgba(0,0,0,0.2);
        }
        .stat-card[onclick] {
            cursor: pointer;
        }
        .stat-card[onclick]:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }
        .stat-icon.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.orange { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.purple { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-info h3 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
            transition: all 0.3s;
            line-height: 1.2;
        }
        .stat-card:hover .stat-info h3 {
            transform: scale(1.05);
        }
        .stat-info p {
            color: #333;
            font-size: 13px;
            font-weight: 500;
            margin: 0;
        }

        /* Content Card */
        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 35px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .content-card:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .content-card h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid;
            border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1;
            font-size: 24px;
            font-weight: 800;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            color: white;
            border-bottom: none;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        tbody tr {
            background: rgba(255,255,255,0.5);
            transition: all 0.3s;
        }
        td {
            padding: 18px 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .profit-positive {
            color: #28a745;
            font-weight: 700;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: 700;
        }

        /* Chart Type Buttons */
        .chart-type-btn {
            padding: 10px 20px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-type-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .chart-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .chart-type-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Chart Tooltip */
        .chart-tooltip {
            position: absolute;
            background: white;
            color: #333;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%) translateY(-5px);
        }
        .chart-tooltip.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .chart-tooltip::before {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid white;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #c62828;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h3 {
            color: #c62828;
            font-size: 24px;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        .close-modal:hover {
            color: #333;
        }

        /* Search */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        /* Image Preview */
        .image-preview {
            width: 100%;
            max-width: 300px;
            height: 300px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            background: #fafafa;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            color: #c62828;
            border-bottom-color: #c62828;
        }

        /* Hidden */
        .hidden {
            display: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Login Modal */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .login-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .login-content h2 {
            color: #c62828;
            margin-bottom: 25px;
            text-align: center;
        }
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .login-input:focus {
            outline: none;
            border-color: #c62828;
        }

        /* Image Upload - Unified */
        .image-upload-unified {
            margin-bottom: 15px;
        }
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .image-upload-area:hover {
            border-color: #c62828;
            background: #fff5f5;
        }
        .image-upload-area.dragover {
            border-color: #c62828;
            background: #fff5f5;
            border-style: solid;
            transform: scale(1.02);
        }
        .image-upload-input {
            display: none;
        }
        .image-url-quick {
            margin-top: 10px;
        }
        .image-url-quick input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .images-preview-grid {
            min-height: 50px;
        }
        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .image-preview-item:hover {
            border-color: #c62828;
            transform: scale(1.05);
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }
        .image-preview-item .remove-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
        .image-preview-item .main-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .image-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .image-option-btn {
            flex: 1;
            padding: 8px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .image-option-btn:hover {
            background: #c62828;
            color: white;
            border-color: #c62828;
        }
        .image-option-btn.active {
            background: #c62828;
            color: white;
            border-color: #c62828;
        }

        /* Size Input */
        .size-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .size-input-item {
            display: flex;
            flex-direction: column;
        }
        .size-input-item label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #666;
        }
        .size-input-item input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .size-input-item input:focus {
            outline: none;
            border-color: #c62828;
        }

        /* Smooth Animations */
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .stat-card {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }

        /* Upload Progress */
        .upload-progress {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 6px;
        }
        .upload-progress.active {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: #c62828;
            transition: width 0.3s;
            width: 0%;
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: rgba(198, 40, 40, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .menu-toggle:hover {
            background: rgba(198, 40, 40, 1);
            transform: scale(1.1);
        }
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .menu-overlay.active {
            display: block;
            opacity: 1;
        }
        @media (max-width: 768px) {
            .sidebar-menu a {
                pointer-events: auto !important;
                z-index: 1001;
                position: relative;
            }
            
            /* Chart responsive */
            .chart-type-btn {
                font-size: 11px !important;
                padding: 8px 10px !important;
                flex: 1 1 calc(50% - 5px) !important;
                min-width: calc(50% - 5px) !important;
            }
            
            .chart-type-btn i {
                font-size: 12px !important;
                margin-right: 4px !important;
            }
            
            #revenueChartCard .content-card {
                padding: 20px 15px !important;
            }
            
            #revenueChartCard [style*="padding: 30px"] {
                padding: 15px 10px !important;
            }
            
            #revenueChartCard [style*="height: 450px"] {
                height: 300px !important;
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            #yAxis {
                min-width: 45px !important;
                padding-right: 8px !important;
                font-size: 9px !important;
                border-right: none !important;
                border-bottom: 1px solid #e0e0e0 !important;
                padding-bottom: 8px !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                height: auto !important;
                width: 100% !important;
            }
            
            #chartLabels {
                font-size: 9px !important;
                padding-top: 5px !important;
                flex-wrap: wrap !important;
                gap: 2px !important;
            }
            
            #chartLabels > div {
                font-size: 8px !important;
                flex: 0 0 auto !important;
                min-width: 0 !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            #revenueChart {
                height: 220px !important;
            }
            
            #chartGrid {
                bottom: 35px !important;
            }
            
            .chart-tooltip {
                font-size: 11px !important;
                padding: 8px 12px !important;
            }
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                width: 280px;
                z-index: 1000;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
                padding-top: 80px;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
                padding: 20px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 10px 8px;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                margin-left: 280px;
                padding: 20px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <h2><i class="fas fa-lock"></i> Đăng Nhập Admin</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="login-input" placeholder="Tên đăng nhập" required autocomplete="username">
                <input type="password" id="loginPassword" class="login-input" placeholder="Mật khẩu" required autocomplete="current-password">
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Đăng Nhập
                </button>
            </form>
            <p id="loginError" style="color: red; margin-top: 15px; text-align: center; display: none;"></p>
        </div>
    </div>

    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-store"></i> Admin Panel</h2>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="showSection('dashboard', event); return false;">
                <i class="fas fa-chart-line"></i> Dashboard
            </a></li>
            <li><a href="#" onclick="showSection('products', event); return false;">
                <i class="fas fa-box"></i> Sản Phẩm
            </a></li>
            <li><a href="#" onclick="showSection('orders', event); return false;">
                <i class="fas fa-shopping-cart"></i> Đơn Hàng
            </a></li>
            <li><a href="#" onclick="showSection('statistics', event); return false;">
                <i class="fas fa-chart-bar"></i> Thống Kê
            </a></li>
            <li><a href="#" onclick="showSection('trash', event); return false;">
                <i class="fas fa-trash"></i> Thùng Rác
            </a></li>
            <li><a href="index.html">
                <i class="fas fa-home"></i> Về Trang Chủ
            </a></li>
            <li><a href="#" onclick="handleLogout(); return false;">
                <i class="fas fa-sign-out-alt"></i> Đăng Xuất
            </a></li>
        </ul>
        <div class="sidebar-user" id="sidebarUser">
            <i class="fas fa-user"></i> <span id="currentUser">Admin</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="page-header">
                <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
                <div>
                    <button class="btn btn-primary" onclick="syncToSheets()" style="margin-right: 10px;">
                        <i class="fas fa-sync"></i> Đồng Bộ Lên Google Sheets
                    </button>
                    <button class="btn btn-secondary" onclick="syncFromSheets()">
                        <i class="fas fa-download"></i> Đồng Bộ Từ Google Sheets
                    </button>
                    <button class="btn btn-success" onclick="openGoogleSheet()" style="margin-left: 10px;">
                        <i class="fas fa-external-link-alt"></i> Mở Google Sheet
                    </button>
                    <button class="btn btn-secondary" onclick="checkGoogleSheetData()" style="margin-left: 10px;">
                        <i class="fas fa-clipboard-check"></i> Kiểm Tra Sheet
                    </button>
                    <button class="btn btn-secondary" onclick="migrateOrderIds()" style="margin-left: 10px; background: #ff9800; border-color: #ff9800;">
                        <i class="fas fa-sync"></i> Đổi Mã Đơn Cũ
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" onclick="navigateToProducts()" style="cursor: pointer;">
                    <div class="stat-icon blue">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalProducts">0</h3>
                        <p>Tổng Sản Phẩm</p>
                    </div>
                </div>
                <div class="stat-card" onclick="navigateToOrders()" style="cursor: pointer;">
                    <div class="stat-icon green">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalOrders">0</h3>
                        <p>Tổng Đơn Hàng</p>
                    </div>
                </div>
                <div class="stat-card" onclick="navigateToRevenue()" style="cursor: pointer;">
                    <div class="stat-icon orange">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRevenue">0 đ</h3>
                        <p>Tổng Doanh Thu</p>
                    </div>
                </div>
                <div class="stat-card" onclick="navigateToPendingOrders()" style="cursor: pointer;">
                    <div class="stat-icon purple">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pendingOrders">0</h3>
                        <p>Đơn Chờ Xử Lý</p>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h2><i class="fas fa-shopping-bag"></i> Đơn Hàng Mới Nhất</h2>
                <div id="recentOrdersContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Recent orders cards will be generated here -->
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="section hidden">
            <div class="page-header">
                <h1><i class="fas fa-box"></i> Quản Lý Sản Phẩm</h1>
                <button class="btn btn-primary" onclick="openProductModal()">
                    <i class="fas fa-plus"></i> Thêm Sản Phẩm
                </button>
            </div>

            <div class="content-card">
                <div class="search-box">
                    <input type="text" id="productSearch" placeholder="Tìm kiếm sản phẩm..." onkeyup="searchProducts()">
                </div>
                <div id="productsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-top: 20px;">
                    <!-- Product cards will be generated here -->
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="section hidden">
            <div class="page-header">
                <h1><i class="fas fa-shopping-cart"></i> Quản Lý Đơn Hàng</h1>
                <button class="btn btn-secondary" onclick="migrateOldOrderIds()" style="background: #6c757d;">
                    <i class="fas fa-sync"></i> Đổi Mã Đơn Hàng Cũ
                </button>
            </div>

            <div class="content-card">
                <div class="tabs">
                    <button class="tab active" onclick="filterOrders('all', event)">Tất Cả</button>
                    <button class="tab" onclick="filterOrders('pending', event)">Chờ Xử Lý</button>
                    <button class="tab" onclick="filterOrders('confirmed', event)">Đã Xác Nhận</button>
                    <button class="tab" onclick="filterOrders('completed', event)">Hoàn Thành</button>
                    <button class="tab" onclick="filterOrders('cancelled', event)">Đã Hủy</button>
                </div>
                <div class="search-box">
                    <input type="text" id="orderSearch" placeholder="Tìm kiếm đơn hàng..." onkeyup="searchOrders()">
                </div>
                <div id="ordersContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Order cards will be generated here -->
                </div>
            </div>
        </div>

        <!-- Trash Section -->
        <div id="trash" class="section hidden">
            <div class="page-header">
                <h1><i class="fas fa-trash"></i> Thùng Rác</h1>
            </div>
            <div class="content-card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ảnh</th>
                                <th>Tên</th>
                                <th>Giá Vốn</th>
                                <th>Giá Thuê</th>
                                <th>Tồn Kho</th>
                                <th>Ngày Xóa</th>
                                <th>Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody id="trashTableBody">
                            <tr><td colspan="8" style="text-align: center; padding: 40px;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="statistics" class="section hidden">
            <div class="page-header">
                <h1><i class="fas fa-chart-bar"></i> Thống Kê</h1>
            </div>

            <div class="content-card" id="revenueStatsSection">
                <h2><i class="fas fa-chart-line"></i> Thống Kê Doanh Thu</h2>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer;" onclick="showRevenueChart('today')">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="todayRevenue" style="color: white; -webkit-text-fill-color: white;">0 đ</h3>
                            <p style="color: rgba(255,255,255,0.9);">Hôm Nay</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; cursor: pointer;" onclick="showRevenueChart('week')">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="weekRevenue" style="color: white; -webkit-text-fill-color: white;">0 đ</h3>
                            <p style="color: rgba(255,255,255,0.9);">Tuần Này</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; cursor: pointer;" onclick="showRevenueChart('month')">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="monthRevenue" style="color: white; -webkit-text-fill-color: white;">0 đ</h3>
                            <p style="color: rgba(255,255,255,0.9);">Tháng Này</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; cursor: pointer;" onclick="showRevenueChart('quarter')">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="quarterRevenue" style="color: white; -webkit-text-fill-color: white;">0 đ</h3>
                            <p style="color: rgba(255,255,255,0.9);">Quý Này</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; cursor: pointer;" onclick="showRevenueChart('year')">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="yearRevenue" style="color: white; -webkit-text-fill-color: white;">0 đ</h3>
                            <p style="color: rgba(255,255,255,0.9);">Năm Này</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h2><i class="fas fa-cubes"></i> Thống Kê Theo Model</h2>
                <div id="modelStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; margin-top: 20px; width: 100%; box-sizing: border-box;">
                    <!-- Model stats cards will be generated here -->
                </div>
            </div>

            <div class="content-card">
                <h2><i class="fas fa-star"></i> Sản Phẩm Bán Chạy</h2>
                <div id="topProductsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-top: 20px;">
                    <!-- Top products cards will be generated here -->
                </div>
            </div>

            <div class="content-card" id="revenueChartCard" style="display: none;">
                <h2><i class="fas fa-chart-bar"></i> Biểu Đồ Doanh Thu</h2>
                
                <!-- Chart Type Selector -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="chart-type-btn active" data-type="today" onclick="selectChartType('today')">
                        <i class="fas fa-calendar-day"></i> Hôm Nay
                    </button>
                    <button class="chart-type-btn" data-type="week" onclick="selectChartType('week')">
                        <i class="fas fa-calendar-week"></i> Tuần Này
                    </button>
                    <button class="chart-type-btn" data-type="month" onclick="selectChartType('month')">
                        <i class="fas fa-calendar-alt"></i> Tháng Này
                    </button>
                    <button class="chart-type-btn" data-type="quarter" onclick="selectChartType('quarter')">
                        <i class="fas fa-calendar"></i> Quý Này
                    </button>
                    <button class="chart-type-btn" data-type="year" onclick="selectChartType('year')">
                        <i class="fas fa-calendar-check"></i> Năm Này
                    </button>
                </div>

                <div style="padding: 30px; background: white; border-radius: 15px; border: 1px solid #e0e0e0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <div style="display: flex; gap: 20px; height: 450px;">
                        <!-- Y-Axis -->
                        <div id="yAxis" style="display: flex; flex-direction: column; justify-content: space-between; padding-right: 15px; border-right: 2px solid #e0e0e0; min-width: 80px;">
                            <!-- Y-axis labels will be generated here -->
                        </div>
                        
                        <!-- Chart Area -->
                        <div style="flex: 1; position: relative;">
                            <!-- Grid Lines -->
                            <div id="chartGrid" style="position: absolute; top: 0; left: 0; right: 0; bottom: 60px; pointer-events: none;">
                                <!-- Grid lines will be generated here -->
                            </div>
                            
                            <!-- SVG Chart -->
                            <svg id="revenueChart" style="width: 100%; height: 100%; position: relative;" viewBox="0 0 800 390" preserveAspectRatio="none">
                                <!-- Chart will be drawn here -->
                            </svg>
                            
                            <!-- X-Axis Labels -->
                            <div id="chartLabels" style="position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: #495057; padding-top: 10px;">
                                <!-- Labels will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Thêm Sản Phẩm Mới</h3>
                <button class="close-modal" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ID Sản Phẩm *</label>
                        <input type="text" id="productIdInput" required>
                    </div>
                    <div class="form-group">
                        <label>Tên Sản Phẩm *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Mô Tả</label>
                        <textarea id="productDesc"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Ảnh Sản Phẩm * (Có thể thêm nhiều ảnh)</label>
                        <div class="image-upload-unified">
                            <div class="image-upload-area" id="unifiedUploadArea" 
                                 onclick="document.getElementById('multiImageFileInput').click()"
                                 ondrop="handleDrop(event)" 
                                 ondragover="handleDragOver(event)" 
                                 ondragleave="handleDragLeave(event)">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 36px; color: #999; margin-bottom: 10px;"></i>
                                <p style="color: #666; margin: 5px 0; font-weight: 600;">Kéo thả ảnh vào đây</p>
                                <p style="color: #999; margin: 0; font-size: 12px;">hoặc Click để chọn • Ctrl+V để dán</p>
                                <input type="file" id="multiImageFileInput" class="image-upload-input" accept="image/*" multiple onchange="handleMultipleImageUpload(event)" style="display: none;">
                            </div>
                            <div class="image-url-quick">
                                <input type="text" id="quickImageUrl" placeholder="Hoặc dán link ảnh và nhấn Enter" 
                                       onkeypress="if(event.key==='Enter') addImageFromUrl(event)">
                                <button type="button" class="btn btn-sm btn-primary" onclick="addImageFromUrl()" style="margin-top: 5px;">
                                    <i class="fas fa-plus"></i> Thêm Link
                                </button>
                            </div>
                        </div>
                        
                        <div class="images-preview-grid" id="imagesPreviewGrid" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                            <span style="color: #999; grid-column: 1/-1;">Chưa có ảnh nào</span>
                        </div>
                        <input type="hidden" id="productImages" name="productImages">
                    </div>
                    <div class="form-group full-width">
                        <label>Số Lượng Theo Size *</label>
                        <div class="size-input-group">
                            <div class="size-input-item">
                                <label>Size S</label>
                                <input type="number" id="sizeS" value="0" min="0" onchange="updateSizesJSON()">
                            </div>
                            <div class="size-input-item">
                                <label>Size M</label>
                                <input type="number" id="sizeM" value="0" min="0" onchange="updateSizesJSON()">
                            </div>
                            <div class="size-input-item">
                                <label>Size L</label>
                                <input type="number" id="sizeL" value="0" min="0" onchange="updateSizesJSON()">
                            </div>
                            <div class="size-input-item">
                                <label>Size XL</label>
                                <input type="number" id="sizeXL" value="0" min="0" onchange="updateSizesJSON()">
                            </div>
                            <div class="size-input-item">
                                <label>Size XXL</label>
                                <input type="number" id="sizeXXL" value="0" min="0" onchange="updateSizesJSON()">
                            </div>
                        </div>
                        <input type="hidden" id="productSizes">
                        <small style="color: #666; display: block; margin-top: 5px;">Nhập số lượng cho từng size</small>
                    </div>
                    <div class="form-group">
                        <label>Giá Vốn (VNĐ) *</label>
                        <input type="number" id="importPrice" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Giá Thuê (VNĐ) *</label>
                        <input type="number" id="rentPrice" required min="0">
                    </div>
                    <div class="form-group">
                        <label>Đang Cho Thuê</label>
                        <input type="number" id="renting" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Lượt Đã Thuê</label>
                        <input type="number" id="rentalCount" value="0" min="0">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chi Tiết Đơn Hàng</h3>
                <button class="close-modal" onclick="closeOrderModal()">&times;</button>
            </div>
            <div id="orderDetailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Model Detail Modal -->
    <div id="modelDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="modelDetailTitle">Chi Tiết Model</h3>
                <button class="close-modal" onclick="closeModelDetailModal()">&times;</button>
            </div>
            <div id="modelDetailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Load config files -->
    <script src="admin-config.js"></script>
    <script src="google-sheets-config.js"></script>
    
    <!-- Load Firebase config (must be after Firebase SDK) -->
    <script src="firebase-config.js"></script>
    
    <!-- Load sync service (needs db and google sheets config) -->
    <script src="sync-service.js"></script>
    
    <script>
        // ========== AUTHENTICATION ==========

        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (!isLoggedIn) {
                document.getElementById('loginModal').style.display = 'flex';
                document.querySelector('.main-content').style.display = 'none';
                document.querySelector('.sidebar').style.display = 'none';
            } else {
                document.getElementById('loginModal').style.display = 'none';
                document.querySelector('.main-content').style.display = 'block';
                // Không hiện sidebar trên mobile, chỉ toggle
                if (window.innerWidth > 768) {
                    document.querySelector('.sidebar').style.display = 'block';
                }
                
                // Show current user
                const username = localStorage.getItem('adminUsername') || 'Admin';
                document.getElementById('currentUser').textContent = username;
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            // Check credentials
            let isValid = false;
            if (username === ADMIN_CONFIG.credentials.username && 
                password === ADMIN_CONFIG.credentials.password) {
                isValid = true;
            }

            if (isValid) {
                localStorage.setItem('adminLoggedIn', 'true');
                localStorage.setItem('adminUsername', username);
                errorEl.style.display = 'none';
                checkAuth();
            } else {
                errorEl.textContent = 'Sai tên đăng nhập hoặc mật khẩu!';
                errorEl.style.display = 'block';
                // Shake animation
                document.querySelector('.login-content').style.animation = 'shake 0.5s';
                setTimeout(() => {
                    document.querySelector('.login-content').style.animation = '';
                }, 500);
            }
        }

        function handleLogout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                localStorage.removeItem('adminLoggedIn');
                checkAuth();
            }
        }

        // ========== IMAGE HANDLING - MULTIPLE IMAGES ==========
        let productImages = [];

        function handleMultipleImageUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToPreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            const area = event.currentTarget;
            area.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToPreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }

        function addImageFromUrl(event) {
            if (event) event.preventDefault();
            const url = document.getElementById('quickImageUrl');
            if (url && url.value.trim()) {
                addImageToPreview(url.value.trim());
                url.value = '';
            }
        }

        function addImageToPreview(imageUrl) {
            if (!productImages.includes(imageUrl)) {
                productImages.push(imageUrl);
                updateImagesPreview();
            }
        }

        function removeImage(index) {
            productImages.splice(index, 1);
            updateImagesPreview();
        }

        function setMainImage(index) {
            if (productImages[index]) {
                const mainImg = productImages[index];
                productImages.splice(index, 1);
                productImages.unshift(mainImg);
                updateImagesPreview();
            }
        }

        function updateImagesPreview() {
            const grid = document.getElementById('imagesPreviewGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (productImages.length === 0) {
                grid.innerHTML = '<span style="color: #999; grid-column: 1/-1;">Chưa có ảnh nào</span>';
            } else {
                productImages.forEach((imgUrl, index) => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    item.innerHTML = `
                        <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/100'">
                        <button type="button" class="remove-btn" onclick="removeImage(${index})" title="Xóa">
                            <i class="fas fa-times"></i>
                        </button>
                        ${index === 0 ? '<span class="main-badge">Ảnh chính</span>' : ''}
                    `;
                    if (index !== 0) {
                        item.style.cursor = 'pointer';
                        item.onclick = () => setMainImage(index);
                        item.title = 'Click để đặt làm ảnh chính';
                    }
                    grid.appendChild(item);
                });
            }
            
            // Update hidden input
            const hiddenInput = document.getElementById('productImages');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(productImages);
            }
        }

        // Handle paste images globally
        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('unifiedUploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const items = Array.from(e.clipboardData.items);
                    items.forEach(item => {
                        if (item.type.indexOf('image') !== -1) {
                            const blob = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                addImageToPreview(e.target.result);
                            };
                            reader.readAsDataURL(blob);
                        }
                    });
                });
            }
        });

        // ========== SIZE INPUT MANAGEMENT ==========
        function updateSizesJSON() {
            const sizes = {
                S: parseInt(document.getElementById('sizeS').value) || 0,
                M: parseInt(document.getElementById('sizeM').value) || 0,
                L: parseInt(document.getElementById('sizeL').value) || 0,
                XL: parseInt(document.getElementById('sizeXL').value) || 0,
                XXL: parseInt(document.getElementById('sizeXXL').value) || 0
            };
            
            // Remove zero sizes
            Object.keys(sizes).forEach(key => {
                if (sizes[key] === 0) delete sizes[key];
            });
            
            document.getElementById('productSizes').value = JSON.stringify(sizes);
        }

        function loadSizesToInputs(sizesJson) {
            let sizes = {};
            try {
                if (typeof sizesJson === 'string') {
                    sizes = JSON.parse(sizesJson);
                } else {
                    sizes = sizesJson || {};
                }
            } catch (e) {
                sizes = {};
            }

            document.getElementById('sizeS').value = sizes.S || 0;
            document.getElementById('sizeM').value = sizes.M || 0;
            document.getElementById('sizeL').value = sizes.L || 0;
            document.getElementById('sizeXL').value = sizes.XL || 0;
            document.getElementById('sizeXXL').value = sizes.XXL || 0;
            
            updateSizesJSON();
        }

        // ========== HELPER FUNCTIONS ==========
        
        // Đảm bảo db đã được khởi tạo
        function ensureDb() {
            if (typeof db === 'undefined' || !db) {
                // Try to get from window
                if (typeof window !== 'undefined' && window.db) {
                    return window.db;
                }
                throw new Error('Firebase db chưa được khởi tạo! Vui lòng đợi vài giây và thử lại.');
            }
            return db;
        }

        // Format số tiền
        const formatMoney = (n) => n.toLocaleString('vi-VN') + ' đ';
        const formatCompact = (n) => {
            if (Math.abs(n) >= 1000000) return (n / 1000000).toFixed(1).replace('.0','') + "tr";
            return (n / 1000).toFixed(0) + "k";
        };
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('vi-VN');
        };

        // Navigation functions for dashboard cards
        function navigateToProducts() {
            showSection('products');
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            const productsLink = document.querySelector('.sidebar-menu a[onclick*="products"]');
            if (productsLink) productsLink.classList.add('active');
        }

        function navigateToOrders() {
            showSection('orders');
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            const ordersLink = document.querySelector('.sidebar-menu a[onclick*="orders"]');
            if (ordersLink) ordersLink.classList.add('active');
        }

        function navigateToRevenue() {
            showSection('statistics');
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            const statsLink = document.querySelector('.sidebar-menu a[onclick*="statistics"]');
            if (statsLink) statsLink.classList.add('active');
            
            // Scroll to revenue section after a short delay
            setTimeout(() => {
                const revenueSection = document.getElementById('revenueStatsSection');
                if (revenueSection) {
                    revenueSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function navigateToPendingOrders() {
            showSection('orders');
            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            const ordersLink = document.querySelector('.sidebar-menu a[onclick*="orders"]');
            if (ordersLink) ordersLink.classList.add('active');
            
            // Filter to pending orders after a short delay
            setTimeout(() => {
                const pendingTab = document.querySelector('.tab[onclick*="pending"]');
                if (pendingTab) {
                    pendingTab.click();
                } else {
                    // Fallback: manually trigger filter
                    filterOrders('pending');
                }
            }, 100);
        }

        // Navigation
        function showSection(sectionId, evt) {
            const e = evt || window.event;
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.getElementById(sectionId).classList.remove('hidden');
            if (e && e.target) {
                const link = e.target.closest ? e.target.closest('a') : null;
                if (link) link.classList.add('active');
            }
            
            // Lưu tab đang chọn vào localStorage
            localStorage.setItem('adminActiveTab', sectionId);
            
            if (sectionId === 'dashboard') loadDashboard();
            if (sectionId === 'products') loadProducts();
            if (sectionId === 'orders') loadOrders();
            if (sectionId === 'statistics') loadStatistics();
            if (sectionId === 'trash') loadTrash();
            
            // Đóng menu trên mobile sau khi chọn
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }
        
        // Restore active tab on load
        function restoreActiveTab() {
            const savedTab = localStorage.getItem('adminActiveTab') || 'dashboard';
            const section = document.getElementById(savedTab);
            if (section) {
                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                section.classList.remove('hidden');
                
                // Set active menu item
                const menuItems = document.querySelectorAll('.sidebar-menu a');
                menuItems.forEach(item => {
                    const href = item.getAttribute('onclick');
                    if (href && href.includes(`'${savedTab}'`)) {
                        item.classList.add('active');
                    }
                });
                
                // Load data for the section
                if (savedTab === 'dashboard') loadDashboard();
                if (savedTab === 'products') loadProducts();
                if (savedTab === 'orders') loadOrders();
                if (savedTab === 'statistics') loadStatistics();
                if (savedTab === 'trash') loadTrash();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menuOverlay');
            const toggle = document.getElementById('menuToggle');
            
            if (sidebar && overlay && toggle) {
                const isActive = sidebar.classList.contains('active');
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                
                // Đổi icon
                const icon = toggle.querySelector('i');
                if (!isActive) {
                    icon.className = 'fas fa-times';
                } else {
                    icon.className = 'fas fa-bars';
                }
            }
        }
        
        // Fix mobile menu - allow clicking menu items
        document.addEventListener('DOMContentLoaded', function() {
            const menuOverlay = document.getElementById('menuOverlay');
            if (menuOverlay) {
                menuOverlay.addEventListener('click', function(e) {
                    // Only close if clicking the overlay itself, not menu items
                    if (e.target === menuOverlay) {
                        toggleSidebar();
                    }
                });
            }
            
            // Ensure menu items are clickable on mobile
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // Let the onclick handler run first, then close menu
                    setTimeout(() => {
                        if (window.innerWidth <= 768) {
                            toggleSidebar();
                        }
                    }, 100);
                });
            });
        });

        // ========== DASHBOARD ==========
        function loadDashboard() {
            const dbInstance = ensureDb();
            // Load stats
            dbInstance.collection('products').get().then(snapshot => {
                document.getElementById('totalProducts').textContent = snapshot.size;
            }).catch(error => {
                console.error('Lỗi tải sản phẩm:', error);
            });

            dbInstance.collection('orders').get().then(snapshot => {
                let totalRevenue = 0;
                let pendingCount = 0;
                snapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.status === 'pending') pendingCount++;
                    totalRevenue += order.total || 0;
                });
                document.getElementById('totalOrders').textContent = snapshot.size;
                document.getElementById('totalRevenue').textContent = formatMoney(totalRevenue);
                document.getElementById('pendingOrders').textContent = pendingCount;
            }).catch(error => {
                console.error('Lỗi tải đơn hàng:', error);
            });

            // Load recent orders
            dbInstance.collection('orders').orderBy('createdAt', 'desc').limit(10).get().then(snapshot => {
                const container = document.getElementById('recentOrdersContainer');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">Chưa có đơn hàng nào</div>';
                } else {
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const card = createOrderCard(doc.id, order);
                        container.appendChild(card);
                    });
                }
            }).catch(error => {
                console.error('Lỗi tải đơn hàng gần đây:', error);
                });
        }

        // Copy order ID
        function copyOrderId(orderId) {
            navigator.clipboard.writeText(orderId).then(() => {
                // Show temporary success message
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Đã Copy';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#c62828';
                }, 2000);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = orderId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Đã Copy';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#c62828';
                }, 2000);
            });
        }

        // Migrate old order IDs to new format
        function migrateOldOrderIds() {
            if (!confirm('Bạn có chắc muốn thêm mã đơn hàng mới (TPNV_XXXXXX) cho các đơn hàng cũ? Đơn hàng cũ sẽ giữ nguyên document ID, chỉ thêm trường orderIdNew.')) {
                return;
            }
            
            const dbInstance = ensureDb();
            let migratedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // Show loading
            const loadingMsg = document.createElement('div');
            loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
            loadingMsg.innerHTML = '<div style="font-size: 18px; font-weight: 700; margin-bottom: 15px;">Đang xử lý...</div><div id="migrateProgress">Đang tải danh sách đơn hàng...</div>';
            document.body.appendChild(loadingMsg);
            
            dbInstance.collection('orders').get().then(snapshot => {
                const ordersToMigrate = [];
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    // Chỉ migrate nếu chưa có orderIdNew
                    if (!orderData.orderIdNew) {
                        ordersToMigrate.push({ docId: doc.id, data: orderData });
                    } else {
                        skippedCount++;
                    }
                });
                
                if (ordersToMigrate.length === 0) {
                    loadingMsg.remove();
                    alert(`Không có đơn hàng nào cần migrate!${skippedCount > 0 ? `\nĐã bỏ qua ${skippedCount} đơn hàng đã có orderIdNew.` : ''}`);
                    return;
                }
                
                document.getElementById('migrateProgress').textContent = `Tìm thấy ${ordersToMigrate.length} đơn hàng cần migrate. Đang xử lý...`;
                
                // Process in batches of 10
                const batchSize = 10;
                let currentIndex = 0;
                const usedIds = new Set();
                
                function processBatch() {
                    const batch = dbInstance.batch();
                    const currentBatch = ordersToMigrate.slice(currentIndex, currentIndex + batchSize);
                    
                    if (currentBatch.length === 0) {
                        loadingMsg.remove();
                        alert(`Đã migrate thành công ${migratedCount} đơn hàng!${skippedCount > 0 ? `\nĐã bỏ qua ${skippedCount} đơn hàng đã có orderIdNew.` : ''}${errors.length > 0 ? `\nLỗi: ${errors.length}` : ''}`);
                        loadOrders();
                        if (!document.getElementById('dashboard').classList.contains('hidden')) {
                            loadDashboard();
                        }
                        return;
                    }
                    
                    currentBatch.forEach(({ docId, data }) => {
                        // Generate new ID
                        let newId;
                        let attempts = 0;
                        do {
                            const randomId = Math.floor(100000 + Math.random() * 900000);
                            newId = `TPNV_${randomId}`;
                            attempts++;
                            if (attempts > 20) {
                                throw new Error(`Không thể tạo mã mới cho ${docId} sau nhiều lần thử`);
                            }
                        } while (usedIds.has(newId));
                        
                        usedIds.add(newId);
                        
                        // Update document với orderIdNew (không đổi document ID)
                        const docRef = dbInstance.collection('orders').doc(docId);
                        batch.update(docRef, { orderIdNew: newId });
                    });
                    
                    batch.commit().then(() => {
                        migratedCount += currentBatch.length;
                        currentIndex += batchSize;
                        document.getElementById('migrateProgress').textContent = `Đã xử lý ${migratedCount}/${ordersToMigrate.length} đơn hàng...`;
                        processBatch();
                    }).catch(error => {
                        console.error('Lỗi commit batch:', error);
                        errorCount += currentBatch.length;
                        errors.push({ batch: currentIndex, error: error.message });
                        currentIndex += batchSize;
                        processBatch();
                    });
                }
                
                processBatch();
            }).catch(error => {
                console.error('Lỗi load orders:', error);
                loadingMsg.remove();
                alert('Có lỗi xảy ra khi tải danh sách đơn hàng!');
            });
        }

        // ========== PRODUCTS ==========
        function createProductCard(productId, product) {
            const card = document.createElement('div');
            card.setAttribute('data-product-id', productId);
            const totalStock = Object.values(product.sizes || {}).reduce((a, b) => a + b, 0);
            const availableStock = totalStock - (product.renting || 0);
            const mainImage = (product.images && Array.isArray(product.images) && product.images.length > 0)
                ? product.images[0]
                : (product.image || 'https://via.placeholder.com/300');
            
            card.style.cssText = `
                background: white;
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.08);
                border: 1px solid #e0e0e0;
                transition: all 0.3s;
                position: relative;
                overflow: hidden;
                display: block;
            `;
            
            card.onmouseenter = function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
                this.style.borderColor = '#c62828';
            };
            
            card.onmouseleave = function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.08)';
                this.style.borderColor = '#e0e0e0';
            };
            
            const sizesList = product.sizes ? Object.entries(product.sizes)
                .filter(([size, qty]) => qty > 0)
                .map(([size, qty]) => `${size}: ${qty}`)
                .join(', ') : 'Chưa có size';
            
            card.innerHTML = `
                <div style="position: relative; width: 100%; height: 140px; overflow: hidden; background: #f8f9fa;">
                    <img src="${mainImage}" 
                         style="width: 100%; height: 100%; object-fit: cover;" 
                         onerror="this.src='https://via.placeholder.com/300'">
                    ${product.images && product.images.length > 1 ? `
                    <div style="position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6); color: white; padding: 3px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                        <i class="fas fa-images"></i> ${product.images.length}
                    </div>
                    ` : ''}
                </div>
                <div style="padding: 12px;">
                    <div style="margin-bottom: 8px;">
                        <div style="font-size: 9px; color: #999; margin-bottom: 2px; font-weight: 600;">ID</div>
                        <div style="font-size: 10px; color: #666; font-weight: 600;">${(product.id || productId).substring(0, 12)}${(product.id || productId).length > 12 ? '...' : ''}</div>
                    </div>
                    <h3 style="font-size: 14px; font-weight: 800; color: #333; margin-bottom: 10px; line-height: 1.3; min-height: 36px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${product.name || 'Chưa có tên'}
                    </h3>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 9px; color: #666; margin-bottom: 2px;">Giá Vốn</div>
                                <div style="font-size: 13px; font-weight: 800; color: #333;">${formatMoney(product.importPrice || 0)}</div>
                            </div>
                            <div>
                                <div style="font-size: 9px; color: #666; margin-bottom: 2px;">Giá Thuê</div>
                                <div style="font-size: 13px; font-weight: 800; color: #c62828;">${formatMoney(product.rentPrice || 0)}</div>
                            </div>
                        </div>
                        <div style="border-top: 1px solid #e0e0e0; padding-top: 8px; margin-top: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                                <div>
                                    <div style="font-size: 9px; color: #666; margin-bottom: 2px;">Tồn</div>
                                    <div style="font-size: 14px; font-weight: 800; color: #28a745;">${totalStock}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: #666; margin-bottom: 2px;">Thuê</div>
                                    <div style="font-size: 14px; font-weight: 800; color: #ffc107;">${product.renting || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: #666; margin-bottom: 2px;">Sẵn</div>
                                    <div style="font-size: 14px; font-weight: 800; color: ${availableStock > 0 ? '#17a2b8' : '#dc3545'};">
                                        ${availableStock}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${sizesList !== 'Chưa có size' ? `
                    <div style="background: #fff3e0; padding: 6px 8px; border-radius: 6px; margin-bottom: 10px; border-left: 2px solid #ffc107;">
                        <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">
                            <i class="fas fa-ruler"></i> Size
                        </div>
                        <div style="font-size: 10px; color: #333; line-height: 1.4;">
                            ${sizesList}
                        </div>
                    </div>
                    ` : ''}
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-sm btn-primary" onclick="editProduct('${productId}')" style="flex: 1; padding: 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i> Sửa
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${productId}')" style="flex: 1; padding: 8px; font-size: 12px;">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        function loadProducts() {
            const dbInstance = ensureDb();
            dbInstance.collection('products').get().then(snapshot => {
                const container = document.getElementById('productsContainer');
                container.innerHTML = '';
                let hasProducts = false;
                snapshot.forEach(doc => {
                    const product = doc.data();
                    // Bỏ qua sản phẩm đã xóa
                    if (product.deleted === true) return;
                    hasProducts = true;
                    const card = createProductCard(doc.id, product);
                    container.appendChild(card);
                });
                if (!hasProducts) {
                    container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #999; font-size: 16px;"><i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i><br>Chưa có sản phẩm nào. Hãy thêm sản phẩm mới!</div>';
                }
            }).catch(error => {
                console.error('Lỗi tải sản phẩm:', error);
            });
        }

        function loadTrash() {
            const dbInstance = ensureDb();
            dbInstance.collection('products').get().then(snapshot => {
                const tbody = document.getElementById('trashTableBody');
                tbody.innerHTML = '';
                let hasTrash = false;
                snapshot.forEach(doc => {
                    const product = doc.data();
                    // Chỉ hiển thị sản phẩm đã xóa
                    if (product.deleted !== true) return;
                    hasTrash = true;
                    const totalStock = Object.values(product.sizes || {}).reduce((a, b) => a + b, 0);
                    const mainImage = (product.images && Array.isArray(product.images) && product.images.length > 0)
                        ? product.images[0]
                        : (product.image || '');
                    let deletedDate = 'N/A';
                    if (product.deletedAt) {
                        if (product.deletedAt.seconds) {
                            deletedDate = new Date(product.deletedAt.seconds * 1000).toLocaleDateString('vi-VN');
                        } else if (product.deletedAt instanceof Date) {
                            deletedDate = product.deletedAt.toLocaleDateString('vi-VN');
                        }
                    }
                    const row = document.createElement('tr');
                    row.style.opacity = '0.7';
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td><img src="${mainImage}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; opacity: 0.5;" onerror="this.src='https://via.placeholder.com/60'"></td>
                        <td>${product.name}</td>
                        <td>${formatMoney(product.importPrice || 0)}</td>
                        <td>${formatMoney(product.rentPrice || 0)}</td>
                        <td>${totalStock}</td>
                        <td>${deletedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="restoreProduct('${doc.id}')">
                                <i class="fas fa-undo"></i> Khôi Phục
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="permanentDeleteProduct('${doc.id}')">
                                <i class="fas fa-trash-alt"></i> Xóa Vĩnh Viễn
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                if (!hasTrash) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">Thùng rác trống</td></tr>';
                }
            }).catch(error => {
                console.error('Lỗi tải thùng rác:', error);
            });
        }

        function openProductModal(productId = null) {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('modalTitle').textContent = 'Thêm Sản Phẩm Mới';
            productImages = [];
            updateImagesPreview();
            
            // Reset sizes
            document.getElementById('sizeS').value = 0;
            document.getElementById('sizeM').value = 0;
            document.getElementById('sizeL').value = 0;
            document.getElementById('sizeXL').value = 0;
            document.getElementById('sizeXXL').value = 0;
            updateSizesJSON();
            
            if (productId) {
                const dbInstance = ensureDb();
                dbInstance.collection('products').doc(productId).get().then(doc => {
                    if (doc.exists) {
                        const p = doc.data();
                        document.getElementById('productId').value = doc.id;
                        document.getElementById('productIdInput').value = p.id;
                        document.getElementById('productName').value = p.name;
                        document.getElementById('productDesc').value = p.desc || '';
                        document.getElementById('importPrice').value = p.importPrice || 0;
                        document.getElementById('rentPrice').value = p.rentPrice || 0;
                        document.getElementById('renting').value = p.renting || 0;
                        document.getElementById('rentalCount').value = p.rentalCount || 0;
                        document.getElementById('modalTitle').textContent = 'Sửa Sản Phẩm';
                        
                        // Load images - support both old (image) and new (images) format
                        if (p.images && Array.isArray(p.images) && p.images.length > 0) {
                            productImages = [...p.images];
                        } else if (p.image) {
                            productImages = [p.image];
                        }
                        updateImagesPreview();
                        
                        // Load sizes to inputs
                        loadSizesToInputs(p.sizes || {});
                    }
                });
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function saveProduct(e) {
            e.preventDefault();
            try {
                // Get images - support multiple images
                const imagesJson = document.getElementById('productImages').value;
                let images = [];
                if (imagesJson) {
                    try {
                        images = JSON.parse(imagesJson);
                    } catch (e) {
                        images = [];
                    }
                }
                
                // Ensure at least one image
                if (images.length === 0) {
                    alert('Vui lòng thêm ít nhất 1 ảnh cho sản phẩm!');
                    return;
                }

                const sizesJson = document.getElementById('productSizes').value;
                const sizes = sizesJson ? JSON.parse(sizesJson) : {};

                const product = {
                    id: document.getElementById('productIdInput').value,
                    name: document.getElementById('productName').value,
                    desc: document.getElementById('productDesc').value,
                    images: images, // New: array of images
                    image: images[0], // Keep for backward compatibility
                    sizes: sizes,
                    importPrice: parseInt(document.getElementById('importPrice').value),
                    rentPrice: parseInt(document.getElementById('rentPrice').value),
                    renting: parseInt(document.getElementById('renting').value),
                    rentalCount: parseInt(document.getElementById('rentalCount').value)
                };

                const productId = document.getElementById('productId').value || product.id;
                product.id = productId;
                
                // Lưu vào Firebase và đồng bộ Google Sheets
                syncService.saveProduct(product)
                    .then(() => {
                        alert('Lưu thành công và đã đồng bộ!');
                        closeProductModal();
                        loadProducts();
                        if (!document.getElementById('dashboard').classList.contains('hidden')) {
                            loadDashboard();
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi:', error);
                        alert('Có lỗi xảy ra!');
                    });
            } catch (error) {
                alert('Vui lòng kiểm tra lại thông tin nhập vào!');
                console.error('Lỗi:', error);
            }
        }

        function editProduct(productId) {
            openProductModal(productId);
        }

        function deleteProduct(productId) {
            if (confirm('Bạn chắc chắn muốn xóa sản phẩm này vào thùng rác?')) {
                const dbInstance = ensureDb();
                // Soft delete - đánh dấu deleted thay vì xóa thật
                dbInstance.collection('products').doc(productId).update({
                    deleted: true,
                    deletedAt: new Date()
                }).then(() => {
                    alert('Đã chuyển sản phẩm vào thùng rác!');
                    loadProducts();
                    if (!document.getElementById('dashboard').classList.contains('hidden')) {
                        loadDashboard();
                    }
                }).catch(error => {
                    console.error('Lỗi xóa:', error);
                    alert('Có lỗi xảy ra khi xóa sản phẩm!');
                });
            }
        }

        function restoreProduct(productId) {
            if (confirm('Bạn muốn khôi phục sản phẩm này?')) {
                const dbInstance = ensureDb();
                dbInstance.collection('products').doc(productId).update({
                    deleted: false,
                    deletedAt: null
                }).then(() => {
                    alert('Đã khôi phục sản phẩm!');
                    loadTrash();
                    loadProducts();
                }).catch(error => {
                    console.error('Lỗi khôi phục:', error);
                    alert('Có lỗi xảy ra!');
                });
            }
        }

        function permanentDeleteProduct(productId) {
            if (confirm('Bạn chắc chắn muốn XÓA VĨNH VIỄN sản phẩm này? Hành động này không thể hoàn tác!')) {
                if (confirm('Xác nhận lần cuối: Xóa vĩnh viễn?')) {
                    // Xóa thật từ Firebase
                    syncService.deleteProduct(productId)
                        .then(() => {
                            alert('Đã xóa vĩnh viễn sản phẩm!');
                            loadTrash();
                        })
                        .catch(error => {
                            console.error('Lỗi xóa vĩnh viễn:', error);
                            // Nếu lỗi Google Sheets, vẫn xóa Firebase
                            const dbInstance = ensureDb();
                            dbInstance.collection('products').doc(productId).delete()
                                .then(() => {
                                    alert('Đã xóa vĩnh viễn sản phẩm (có thể lỗi đồng bộ Google Sheets)!');
                                    loadTrash();
                                })
                                .catch(err => {
                                    console.error('Lỗi:', err);
                                    alert('Có lỗi xảy ra!');
                                });
                        });
                }
            }
        }

        function searchProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#productsContainer > div[data-product-id]');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ========== ORDERS ==========
        let currentOrderFilter = 'all';
        function loadOrders() {
            const dbInstance = ensureDb();
            let query = dbInstance.collection('orders').orderBy('createdAt', 'desc');
            
            query.get().then(snapshot => {
                const container = document.getElementById('ordersContainer');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #999; font-size: 16px;"><i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i><br>Chưa có đơn hàng nào</div>';
                } else {
                    let hasOrders = false;
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        if (filterOrderByStatus(order.status)) {
                            const card = createOrderCard(doc.id, order);
                            container.appendChild(card);
                            hasOrders = true;
                        }
                    });
                    if (!hasOrders) {
                        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #999; font-size: 16px;"><i class="fas fa-filter" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i><br>Không có đơn hàng nào với trạng thái này</div>';
                    }
                }
            }).catch(error => {
                console.error('Lỗi tải đơn hàng:', error);
            });
        }

        // Helper function to get display order ID (prefer orderIdNew)
        function getDisplayOrderId(orderId, order) {
            return order?.orderIdNew || orderId;
        }

        function createOrderCard(orderId, order) {
            const displayOrderId = getDisplayOrderId(orderId, order);
            const card = document.createElement('div');
            card.setAttribute('data-order-id', orderId);
            const statusBadge = getStatusBadge(order.status);
            const statusColors = {
                'pending': { bg: '#fff3cd', border: '#ffc107', text: '#856404' },
                'confirmed': { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' },
                'completed': { bg: '#d4edda', border: '#28a745', text: '#155724' },
                'cancelled': { bg: '#f8d7da', border: '#dc3545', text: '#721c24' }
            };
            const statusInfo = statusColors[order.status] || statusColors.pending;
            const itemsCount = order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            const itemsList = order.items ? order.items.slice(0, 2).map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
            const hasMoreItems = order.items && order.items.length > 2;
            
            card.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                border: 2px solid ${statusInfo.border};
                transition: all 0.3s;
                position: relative;
                overflow: hidden;
            `;
            card.onmouseenter = function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            };
            card.onmouseleave = function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.08)';
            };
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <div style="font-size: 12px; color: #666; font-weight: 600;">Mã Đơn</div>
                            <button onclick="copyOrderId('${displayOrderId}')" style="background: #c62828; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;" title="Copy mã đơn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <div style="font-size: 16px; font-weight: 800; color: #333; word-break: break-all;">${displayOrderId}</div>
                    </div>
                    <div style="text-align: right;">
                        ${statusBadge}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px; font-weight: 600;">
                        <i class="fas fa-user"></i> Khách Hàng
                    </div>
                    <div style="font-size: 16px; font-weight: 700; color: #333; margin-bottom: 8px;">${order.customerName || 'N/A'}</div>
                    <div style="font-size: 13px; color: #666;">
                        <i class="fas fa-phone"></i> ${order.customerPhone || 'N/A'}
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Số Lượng SP</div>
                            <div style="font-size: 18px; font-weight: 800; color: #333;">${itemsCount}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">Tổng Tiền</div>
                            <div style="font-size: 20px; font-weight: 800; color: #c62828;">${formatMoney(order.total || 0)}</div>
                        </div>
                    </div>
                    ${order.items && order.items.length > 0 ? `
                    <div style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 5px; font-weight: 600;">
                            <i class="fas fa-box"></i> Sản Phẩm:
                        </div>
                        <div style="font-size: 12px; color: #333; line-height: 1.5;">
                            ${itemsList}${hasMoreItems ? ` <span style="color: #c62828; font-weight: 600;">+${order.items.length - 2} sản phẩm khác</span>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div style="font-size: 12px; color: #999; margin-bottom: 15px;">
                    <i class="fas fa-calendar"></i> ${formatDate(order.createdAt)}
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-success" onclick="viewOrder('${orderId}')" style="flex: 1;">
                        <i class="fas fa-eye"></i> Xem
                    </button>
                    <select onchange="updateOrderStatus('${orderId}', this.value)" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 12px; background: white; cursor: pointer;">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Chờ Xử Lý</option>
                        <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Đã Xác Nhận</option>
                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Hoàn Thành</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Đã Hủy</option>
                    </select>
                </div>
            `;
            return card;
        }

        function createOrderRow(orderId, order) {
            const row = document.createElement('tr');
            const statusBadge = getStatusBadge(order.status);
            const itemsText = order.items ? order.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
            const displayOrderId = getDisplayOrderId(orderId, order);
            
            row.innerHTML = `
                <td>${displayOrderId.length > 12 ? displayOrderId.substring(0, 12) + '...' : displayOrderId}</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>${order.customerPhone || 'N/A'}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${itemsText}</td>
                <td>${formatMoney(order.total || 0)}</td>
                <td>${statusBadge}</td>
                <td>${formatDate(order.createdAt)}</td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="viewOrder('${orderId}')">
                        <i class="fas fa-eye"></i> Xem
                    </button>
                    <select onchange="updateOrderStatus('${orderId}', this.value)" style="padding: 6px; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Chờ Xử Lý</option>
                        <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Đã Xác Nhận</option>
                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Hoàn Thành</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Đã Hủy</option>
                    </select>
                </td>
            `;
            return row;
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge badge-warning">Chờ Xử Lý</span>',
                'confirmed': '<span class="badge badge-info">Đã Xác Nhận</span>',
                'completed': '<span class="badge badge-success">Hoàn Thành</span>',
                'cancelled': '<span class="badge badge-danger">Đã Hủy</span>'
            };
            return badges[status] || '<span class="badge">N/A</span>';
        }

        function filterOrders(status, evt) {
            const e = evt || window.event;
            currentOrderFilter = status;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (e && e.target) e.target.classList.add('active');
            loadOrders();
        }

        function filterOrderByStatus(status) {
            if (currentOrderFilter === 'all') return true;
            return status === currentOrderFilter;
        }

        function updateOrderStatus(orderId, newStatus) {
            // Cập nhật Firebase và đồng bộ Google Sheets
            syncService.updateOrder(orderId, { status: newStatus })
                .then(() => {
                    alert('Cập nhật trạng thái thành công và đã đồng bộ!');
                    loadOrders();
                    if (!document.getElementById('dashboard').classList.contains('hidden')) {
                        loadDashboard();
                    }
                })
                .catch(error => {
                    console.error('Lỗi cập nhật:', error);
                    alert('Có lỗi xảy ra!');
                });
        }

        function viewOrder(orderId) {
            const dbInstance = ensureDb();
            dbInstance.collection('orders').doc(orderId).get().then(doc => {
                if (doc.exists) {
                    const order = doc.data();
                    const content = document.getElementById('orderDetailContent');
                    const statusText = {
                        'pending': 'Chờ Xử Lý',
                        'confirmed': 'Đã Xác Nhận',
                        'completed': 'Hoàn Thành',
                        'cancelled': 'Đã Hủy'
                    };
                    const statusColors = {
                        'pending': { bg: '#fff3cd', text: '#856404' },
                        'confirmed': { bg: '#d1ecf1', text: '#0c5460' },
                        'completed': { bg: '#d4edda', text: '#155724' },
                        'cancelled': { bg: '#f8d7da', text: '#721c24' }
                    };
                    const statusInfo = statusColors[order.status] || statusColors.pending;
                    
                    const displayOrderId = order.orderIdNew || orderId;
                    content.innerHTML = `
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #c62828;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px; font-weight: 600;">Mã Đơn Hàng</div>
                                    <div style="font-size: 16px; font-weight: 800; color: #333; word-break: break-all; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        ${displayOrderId}
                                        <button onclick="copyOrderId('${displayOrderId}')" style="background: #c62828; color: white; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                </div>
                                <div style="padding: 6px 12px; background: ${statusInfo.bg}; color: ${statusInfo.text}; border-radius: 18px; font-weight: 700; font-size: 12px; white-space: nowrap;">
                                    ${statusText[order.status] || 'Chờ Xử Lý'}
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                <i class="fas fa-calendar"></i> ${formatDate(order.createdAt)}
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e0e0e0;">
                            <h4 style="color: #c62828; margin-bottom: 12px; font-size: 14px; font-weight: 800; display: flex; align-items: center; gap: 8px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;">
                                <i class="fas fa-user-circle"></i> Thông Tin Khách Hàng
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #c62828;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 5px; font-weight: 600;">
                                        <i class="fas fa-user"></i> Tên
                                    </div>
                                    <div style="font-size: 14px; font-weight: 700; color: #333;">${order.customerName || 'N/A'}</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #17a2b8;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 5px; font-weight: 600;">
                                        <i class="fas fa-phone"></i> SĐT
                                    </div>
                                    <div style="font-size: 14px; font-weight: 700; color: #333;">${order.customerPhone || 'N/A'}</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745; grid-column: 1 / -1;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 5px; font-weight: 600;">
                                        <i class="fas fa-map-marker-alt"></i> Địa Chỉ
                                    </div>
                                    <div style="font-size: 13px; color: #333; line-height: 1.5;">${order.customerAddress || 'N/A'}</div>
                                </div>
                                ${order.rentalDate ? `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 5px; font-weight: 600;">
                                        <i class="fas fa-calendar-check"></i> Ngày Thuê
                                    </div>
                                    <div style="font-size: 13px; font-weight: 700; color: #333;">${order.rentalDate}</div>
                                </div>
                                ` : ''}
                                ${order.returnDate ? `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #17a2b8;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 5px; font-weight: 600;">
                                        <i class="fas fa-calendar-times"></i> Ngày Trả
                                    </div>
                                    <div style="font-size: 13px; font-weight: 700; color: #333;">${order.returnDate}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e0e0e0;">
                            <h4 style="color: #c62828; margin-bottom: 12px; font-size: 14px; font-weight: 800; display: flex; align-items: center; gap: 8px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;">
                                <i class="fas fa-shopping-bag"></i> Sản Phẩm
                            </h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); color: white;">
                                            <th style="padding: 10px; text-align: left; font-weight: 700; font-size: 11px;">Tên SP</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 700; font-size: 11px;">SL</th>
                                            <th style="padding: 10px; text-align: right; font-weight: 700; font-size: 11px;">Đơn Giá</th>
                                            <th style="padding: 10px; text-align: right; font-weight: 700; font-size: 11px;">Thành Tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${order.items ? order.items.map((item, index) => `
                                            <tr style="border-bottom: 1px solid #e0e0e0; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                                                <td style="padding: 10px; font-weight: 600; color: #333; font-size: 12px;">${item.name || 'N/A'}</td>
                                                <td style="padding: 10px; text-align: center; color: #666; font-size: 12px; font-weight: 600;">${item.quantity || 0}</td>
                                                <td style="padding: 10px; text-align: right; color: #666; font-size: 12px;">${formatMoney(item.price || 0)}</td>
                                                <td style="padding: 10px; text-align: right; font-weight: 700; color: #c62828; font-size: 13px;">${formatMoney((item.price || 0) * (item.quantity || 0))}</td>
                                            </tr>
                                        `).join('') : '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999; font-size: 13px;">Không có sản phẩm</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #ffcc80;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                                <div style="font-size: 16px; font-weight: 700; color: #333; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-money-bill-wave"></i> Tổng Tiền:
                                </div>
                                <div style="font-size: 24px; font-weight: 900; color: #c62828;">${formatMoney(order.total || 0)}</div>
                            </div>
                            ${order.notes ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                                <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-sticky-note"></i> Ghi Chú:
                                </div>
                                <div style="font-size: 12px; color: #333; line-height: 1.5; background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #c62828;">${order.notes}</div>
                            </div>
                            ` : ''}
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="printInvoice('${orderId}')" style="flex: 1; padding: 10px; font-size: 13px; font-weight: 600;">
                                <i class="fas fa-print"></i> In Hóa Đơn
                            </button>
                            <button class="btn btn-secondary" onclick="closeOrderModal()" style="flex: 1; padding: 10px; font-size: 13px; font-weight: 600;">
                                <i class="fas fa-times"></i> Đóng
                            </button>
                        </div>
                    `;
                    document.getElementById('orderModal').classList.add('active');
                }
            }).catch(error => {
                console.error('Lỗi tải đơn hàng:', error);
                alert('Có lỗi xảy ra khi tải đơn hàng!');
            });
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function showModelDetails(model) {
            const modal = document.getElementById('modelDetailModal');
            const content = document.getElementById('modelDetailContent');
            const title = document.getElementById('modelDetailTitle');
            
            title.textContent = `Chi Tiết Model: ${model.model}`;
            
            const avgImportPrice = model.totalQuantity > 0 ? Math.round(model.totalImportCost / model.totalQuantity) : 0;
            const avgRentPrice = model.totalRentals > 0 ? Math.round(model.totalRevenue / model.totalRentals) : 0;
            const profit = model.totalRevenue - model.totalImportCost;
            const profitPercent = model.totalImportCost > 0 ? Math.round((profit / model.totalImportCost) * 100) : 0;
            const isProfit = profit >= 0;
            
            let productsHtml = '';
            model.products.forEach((product, index) => {
                const totalStock = Object.values(product.sizes || {}).reduce((a, b) => a + b, 0);
                const availableStock = totalStock - (product.renting || 0);
                const productImportCost = (product.importPrice || 0) * totalStock;
                const productRevenue = (product.rentPrice || 0) * (product.rentalCount || 0);
                const productProfit = productRevenue - productImportCost;
                const productProfitPercent = productImportCost > 0 ? Math.round((productProfit / productImportCost) * 100) : 0;
                const productIsProfit = productProfit >= 0;
                
                const mainImage = (product.images && Array.isArray(product.images) && product.images.length > 0)
                    ? product.images[0]
                    : (product.image || 'https://via.placeholder.com/100');
                
                productsHtml += `
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;" onmouseenter="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                        <div style="width: 100%; height: 120px; overflow: hidden; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <img src="${mainImage}" 
                                 style="width: 100%; height: 100%; object-fit: cover;" 
                                 onerror="this.src='https://via.placeholder.com/280'">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 14px; font-weight: 800; color: #333; margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${product.name || 'N/A'}
                            </div>
                            <div style="font-size: 10px; color: #999; margin-bottom: 8px;">ID: ${product.id || 'N/A'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Giá Vốn</div>
                                <div style="font-size: 12px; font-weight: 800; color: #333;">${formatMoney(product.importPrice || 0)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Giá Thuê</div>
                                <div style="font-size: 12px; font-weight: 800; color: #c62828;">${formatMoney(product.rentPrice || 0)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Tồn</div>
                                <div style="font-size: 12px; font-weight: 800; color: #28a745;">${totalStock}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Thuê</div>
                                <div style="font-size: 12px; font-weight: 800; color: #ffc107;">${product.renting || 0}</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 4px; font-weight: 600;">Vốn Nhập</div>
                            <div style="font-size: 14px; font-weight: 800; color: #495057;">${formatMoney(productImportCost)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, ${productIsProfit ? '#d4edda' : '#f8d7da'} 0%, ${productIsProfit ? '#c3e6cb' : '#f5c6cb'} 100%); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid ${productIsProfit ? '#c3e6cb' : '#f5c6cb'};">
                            <div style="font-size: 9px; color: #666; margin-bottom: 4px; font-weight: 600;">Doanh Thu</div>
                            <div style="font-size: 14px; font-weight: 800; color: ${productIsProfit ? '#155724' : '#721c24'};">
                                ${formatMoney(productRevenue)}
                            </div>
                        </div>
                        <div style="background: ${productIsProfit ? '#d4edda' : '#f8d7da'}; padding: 8px; border-radius: 6px; border-left: 3px solid ${productIsProfit ? '#28a745' : '#dc3545'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 10px; color: #666; font-weight: 600;">Lãi/Lỗ:</div>
                                <div style="font-size: 14px; font-weight: 800; color: ${productIsProfit ? '#28a745' : '#dc3545'};">
                                    ${productIsProfit ? '+' : ''}${formatMoney(productProfit)}
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 10px; color: ${productIsProfit ? '#28a745' : '#dc3545'}; font-weight: 600; margin-top: 2px;">
                                (${productIsProfit ? '+' : ''}${productProfitPercent}%)
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid ${isProfit ? '#28a745' : '#dc3545'};">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px; font-weight: 600;">Tổng Số Lượng</div>
                            <div style="font-size: 20px; font-weight: 800; color: #333;">${model.totalQuantity}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px; font-weight: 600;">Tổng Lượt Thuê</div>
                            <div style="font-size: 20px; font-weight: 800; color: #333;">${model.totalRentals}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px; font-weight: 600;">Tổng Vốn Nhập</div>
                            <div style="font-size: 18px; font-weight: 800; color: #495057;">${formatMoney(model.totalImportCost)}</div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">${formatMoney(avgImportPrice)}/SP</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px; font-weight: 600;">Tổng Doanh Thu</div>
                            <div style="font-size: 18px; font-weight: 800; color: ${isProfit ? '#155724' : '#721c24'};">
                                ${formatMoney(model.totalRevenue)}
                            </div>
                            <div style="font-size: 10px; color: ${isProfit ? '#155724' : '#721c24'}; margin-top: 3px;">
                                ${formatMoney(avgRentPrice)}/SP
                            </div>
                        </div>
                    </div>
                    <div style="background: ${isProfit ? '#d4edda' : '#f8d7da'}; padding: 12px; border-radius: 8px; border-left: 3px solid ${isProfit ? '#28a745' : '#dc3545'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: #666; font-weight: 600;">Tổng Lãi/Lỗ:</div>
                            <div style="font-size: 20px; font-weight: 800; color: ${isProfit ? '#28a745' : '#dc3545'};">
                                ${isProfit ? '+' : ''}${formatMoney(profit)} (${isProfit ? '+' : ''}${profitPercent}%)
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <h4 style="font-size: 16px; font-weight: 800; color: #333; margin-bottom: 12px;">
                        <i class="fas fa-box"></i> Danh Sách Sản Phẩm (${model.products.length})
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                        ${productsHtml}
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeModelDetailModal() {
            document.getElementById('modelDetailModal').classList.remove('active');
        }

        // ESC key to close model detail modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
                const modelModal = document.getElementById('modelDetailModal');
                if (modelModal && modelModal.classList.contains('active')) {
                    closeModelDetailModal();
                }
            }
        });

        function printInvoice(orderId) {
            // Lưu orderId để hoadon.html load
            localStorage.setItem('currentOrderId', orderId);
            // Mở hóa đơn trong tab mới
            window.open('hoadon.html?orderId=' + orderId, '_blank');
        }

        function searchOrders() {
            const search = document.getElementById('orderSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#ordersContainer > div[data-order-id]');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ========== STATISTICS ==========
        function loadStatistics() {
            const dbInstance = ensureDb();
            const now = new Date();
            
            // Calculate date ranges
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Calculate quarter start (Q1: Jan-Mar, Q2: Apr-Jun, Q3: Jul-Sep, Q4: Oct-Dec)
            const currentQuarter = Math.floor(now.getMonth() / 3);
            const quarterStart = new Date(now.getFullYear(), currentQuarter * 3, 1);
            
            // Calculate year start
            const yearStart = new Date(now.getFullYear(), 0, 1);

            dbInstance.collection('orders').get().then(snapshot => {
                let todayRevenue = 0, weekRevenue = 0, monthRevenue = 0, quarterRevenue = 0, yearRevenue = 0;
                const productStats = {};

                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                    const total = order.total || 0;

                    if (orderDate >= todayStart) todayRevenue += total;
                    if (orderDate >= weekStart) weekRevenue += total;
                    if (orderDate >= monthStart) monthRevenue += total;
                    if (orderDate >= quarterStart) quarterRevenue += total;
                    if (orderDate >= yearStart) yearRevenue += total;

                    if (order.items && order.status === 'completed') {
                        order.items.forEach(item => {
                            if (!productStats[item.productId]) {
                                productStats[item.productId] = {
                                    name: item.name,
                                    count: 0,
                                    revenue: 0
                                };
                            }
                            productStats[item.productId].count += item.quantity;
                            productStats[item.productId].revenue += item.price * item.quantity;
                        });
                    }
                });

                // Update revenue displays
                document.getElementById('todayRevenue').textContent = formatMoney(todayRevenue);
                document.getElementById('weekRevenue').textContent = formatMoney(weekRevenue);
                document.getElementById('monthRevenue').textContent = formatMoney(monthRevenue);
                document.getElementById('quarterRevenue').textContent = formatMoney(quarterRevenue);
                document.getElementById('yearRevenue').textContent = formatMoney(yearRevenue);

                // Store revenues for chart
                allRevenues = {
                    today: todayRevenue,
                    week: weekRevenue,
                    month: monthRevenue,
                    quarter: quarterRevenue,
                    year: yearRevenue
                };

                // Don't auto-load chart, wait for user to click on revenue card

                // Top products - render as cards
                const topProducts = Object.values(productStats)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);
                
                const container = document.getElementById('topProductsContainer');
                container.innerHTML = '';
                if (topProducts.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">Chưa có dữ liệu</div>';
                } else {
                    topProducts.forEach((product, index) => {
                        const card = document.createElement('div');
                        card.style.cssText = `
                            background: linear-gradient(135deg, ${index < 3 ? '#667eea' : '#f8f9fa'} 0%, ${index < 3 ? '#764ba2' : '#e9ecef'} 100%);
                            color: ${index < 3 ? 'white' : '#333'};
                            padding: 12px;
                            border-radius: 12px;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
                            transition: all 0.3s;
                            position: relative;
                            overflow: hidden;
                        `;
                        card.onmouseenter = function() {
                            this.style.transform = 'translateY(-5px)';
                            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
                        };
                        card.onmouseleave = function() {
                            this.style.transform = 'translateY(0)';
                            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
                        };
                        
                        const rankBadge = index < 3 ? `
                            <div style="position: absolute; top: 6px; right: 6px; background: rgba(255,255,255,0.3); padding: 3px 8px; border-radius: 15px; font-weight: 800; font-size: 11px;">
                                #${index + 1}
                            </div>
                        ` : '';
                        
                        card.innerHTML = `
                            ${rankBadge}
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,${index < 3 ? '0.2' : '0.1'}); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 800;">
                                    ${index + 1}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${product.name}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,${index < 3 ? '0.3' : '0.15'});">
                                <div>
                                    <div style="font-size: 10px; opacity: ${index < 3 ? '0.9' : '0.7'}; margin-bottom: 4px; font-weight: 600;">Lượt Thuê</div>
                                    <div style="font-size: 18px; font-weight: 800;">${product.count}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 10px; opacity: ${index < 3 ? '0.9' : '0.7'}; margin-bottom: 4px; font-weight: 600;">Doanh Thu</div>
                                    <div style="font-size: 18px; font-weight: 800;">${formatMoney(product.revenue)}</div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
            }).catch(error => {
                console.error('Lỗi tải thống kê:', error);
            });

            // Load Model Statistics
            loadModelStatistics();
        }

        let currentChartType = 'today';
        let allRevenues = { today: 0, week: 0, month: 0, quarter: 0, year: 0 };
        let chartDataPoints = {}; // Store detailed data points for line chart

        // Show revenue chart when clicking on revenue cards
        function showRevenueChart(type) {
            // Show chart card
            const chartCard = document.getElementById('revenueChartCard');
            if (chartCard) {
                chartCard.style.display = 'block';
                // Scroll to chart
                setTimeout(() => {
                    chartCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
            
            // Select the chart type
            selectChartType(type);
        }

        // Select Chart Type
        function selectChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-type') === type);
            });
            loadChartData(type);
        }

        // Load detailed chart data
        function loadChartData(type) {
            const dbInstance = ensureDb();
            const now = new Date();
            let startDate, endDate, dataPoints = [];
            
            if (type === 'today') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                // Group by hours (24 points)
                for (let i = 0; i < 24; i++) {
                    dataPoints.push({ label: `${i}h`, date: new Date(startDate.getTime() + i * 60 * 60 * 1000), value: 0 });
                }
            } else if (type === 'week') {
                startDate = new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);
                // Group by days (7 points)
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                    const dayName = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()];
                    dataPoints.push({ label: `${dayName} ${date.getDate()}/${date.getMonth() + 1}`, date: date, value: 0 });
                }
            } else if (type === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                const daysInMonth = endDate.getDate();
                // Group by days
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth(), i);
                    dataPoints.push({ label: `${i}/${now.getMonth() + 1}`, date: date, value: 0 });
                }
            } else if (type === 'quarter') {
                const currentQuarter = Math.floor(now.getMonth() / 3);
                startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
                endDate = new Date(now.getFullYear(), (currentQuarter + 1) * 3, 0, 23, 59, 59);
                // Group by months (3 points)
                for (let i = 0; i < 3; i++) {
                    const date = new Date(now.getFullYear(), currentQuarter * 3 + i, 1);
                    dataPoints.push({ label: `Tháng ${date.getMonth() + 1}`, date: date, value: 0 });
                }
            } else if (type === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                // Group by months (12 points)
                for (let i = 0; i < 12; i++) {
                    const date = new Date(now.getFullYear(), i, 1);
                    dataPoints.push({ label: `Tháng ${i + 1}`, date: date, value: 0 });
                }
            }
            
            // Load orders and aggregate by time period
            dbInstance.collection('orders').get().then(snapshot => {
                snapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.status !== 'completed') return;
                    
                    const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                    const total = order.total || 0;
                    
                    if (orderDate < startDate || orderDate > endDate) return;
                    
                    // Find which data point this order belongs to
                    dataPoints.forEach(point => {
                        if (type === 'today') {
                            if (orderDate.getHours() === parseInt(point.label)) {
                                point.value += total;
                            }
                        } else if (type === 'week' || type === 'month') {
                            if (orderDate.getDate() === point.date.getDate() && 
                                orderDate.getMonth() === point.date.getMonth() &&
                                orderDate.getFullYear() === point.date.getFullYear()) {
                                point.value += total;
                            }
                        } else if (type === 'quarter' || type === 'year') {
                            if (orderDate.getMonth() === point.date.getMonth() &&
                                orderDate.getFullYear() === point.date.getFullYear()) {
                                point.value += total;
                            }
                        }
                    });
                });
                
                chartDataPoints[type] = dataPoints;
                renderLineChart(type, dataPoints);
            }).catch(error => {
                console.error('Lỗi tải dữ liệu biểu đồ:', error);
            });
        }

        // Smooth curve helper (Catmull-Rom spline) - but keep zero values at baseline and prevent upward curves when decreasing
        function createSmoothPath(points, baselineY) {
            if (points.length < 2) return '';
            if (points.length === 2) {
                return `M ${points[0].x} ${points[0].y} L ${points[1].x} ${points[1].y}`;
            }
            
            let path = `M ${points[0].x} ${points[0].y}`;
            
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];
                
                // If either point is at baseline (value = 0), use straight line
                if (Math.abs(p1.y - baselineY) < 1 || Math.abs(p2.y - baselineY) < 1) {
                    path += ` L ${p2.x} ${p2.y}`;
                } else {
                    // Use smooth curve only for non-zero values
                    const p0 = points[Math.max(0, i - 1)];
                    const p3 = points[Math.min(points.length - 1, i + 2)];
                    
                    // Calculate control points
                    let cp1x = p1.x + (p2.x - p0.x) / 6;
                    let cp1y = p1.y + (p2.y - p0.y) / 6;
                    let cp2x = p2.x - (p3.x - p1.x) / 6;
                    let cp2y = p2.y - (p3.y - p1.y) / 6;
                    
                    // Clamp control points to not go below baseline
                    cp1y = Math.max(cp1y, baselineY);
                    cp2y = Math.max(cp2y, baselineY);
                    
                    // Prevent upward curves when value is decreasing (p2.y > p1.y means value decreased)
                    // In SVG, y increases downward, so higher y = lower value
                    if (p2.y > p1.y) {
                        // Value is decreasing - ensure control points don't go above p1.y (don't curve upward)
                        cp1y = Math.min(cp1y, p1.y);
                        cp2y = Math.min(cp2y, p2.y);
                    } else if (p2.y < p1.y) {
                        // Value is increasing - ensure control points don't go below p1.y (don't curve downward)
                        cp1y = Math.max(cp1y, p1.y);
                        cp2y = Math.max(cp2y, p2.y);
                    }
                    
                    path += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
            }
            
            return path;
        }

        // Render Line Chart
        function renderLineChart(type, dataPoints) {
            const svg = document.getElementById('revenueChart');
            const labelsContainer = document.getElementById('chartLabels');
            const yAxisContainer = document.getElementById('yAxis');
            const gridContainer = document.getElementById('chartGrid');
            
            svg.innerHTML = '';
            labelsContainer.innerHTML = '';
            yAxisContainer.innerHTML = '';
            gridContainer.innerHTML = '';
            
            if (!dataPoints || dataPoints.length === 0) {
                svg.innerHTML = '<text x="400" y="195" text-anchor="middle" fill="#999" font-size="16" font-weight="600">Chưa có dữ liệu</text>';
                return;
            }
            
            const values = dataPoints.map(p => p.value);
            const maxValue = Math.max(...values, 1) * 1.1; // 10% padding
            const chartWidth = 800;
            const chartHeight = 390;
            const padding = { top: 30, right: 50, bottom: 60, left: 0 };
            const plotWidth = chartWidth - padding.left - padding.right;
            const plotHeight = chartHeight - padding.top - padding.bottom;
            
            // Color scheme based on type
            const colorSchemes = {
                today: { line: '#667eea', area: '#667eea', dot: '#667eea' },
                week: { line: '#f093fb', area: '#f5576c', dot: '#f5576c' },
                month: { line: '#4facfe', area: '#00f2fe', dot: '#4facfe' },
                quarter: { line: '#43e97b', area: '#38f9d7', dot: '#43e97b' },
                year: { line: '#fa709a', area: '#fee140', dot: '#fa709a' }
            };
            const colors = colorSchemes[type] || colorSchemes.month;
            
            // Create Y-axis labels
            const ySteps = 5;
            for (let i = ySteps; i >= 0; i--) {
                const value = (maxValue / ySteps) * i;
                const yLabel = document.createElement('div');
                yLabel.style.cssText = `
                    font-size: 13px;
                    font-weight: 700;
                    color: #495057;
                    text-align: right;
                `;
                yLabel.textContent = formatCompact(value);
                yAxisContainer.appendChild(yLabel);
            }
            
            // Create grid lines
            for (let i = 0; i <= ySteps; i++) {
                const y = (i / ySteps) * plotHeight;
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', padding.left);
                gridLine.setAttribute('y1', padding.top + y);
                gridLine.setAttribute('x2', chartWidth - padding.right);
                gridLine.setAttribute('y2', padding.top + y);
                gridLine.setAttribute('stroke', i === 0 ? '#cbd5e0' : '#f1f5f9');
                gridLine.setAttribute('stroke-width', i === 0 ? '2' : '1');
                gridLine.setAttribute('stroke-dasharray', i === 0 ? '0' : '3,3');
                svg.appendChild(gridLine);
            }
            
            // Calculate points - ensure zero values are exactly at baseline
            const baselineY = padding.top + plotHeight;
            const points = dataPoints.map((point, index) => {
                const x = padding.left + (index / (dataPoints.length - 1 || 1)) * plotWidth;
                // If value is 0 or very close to 0, use baseline Y exactly
                const y = point.value <= 0 ? baselineY : padding.top + plotHeight - (point.value / maxValue) * plotHeight;
                return { x, y, ...point };
            });
            
            // Create gradient definitions
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            // Area gradient
            const areaGradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            areaGradient.setAttribute('id', 'areaGradient');
            areaGradient.setAttribute('x1', '0%');
            areaGradient.setAttribute('y1', '0%');
            areaGradient.setAttribute('x2', '0%');
            areaGradient.setAttribute('y2', '100%');
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('stop-color', colors.area);
            stop1.setAttribute('stop-opacity', '0.4');
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('stop-color', colors.area);
            stop2.setAttribute('stop-opacity', '0');
            areaGradient.appendChild(stop1);
            areaGradient.appendChild(stop2);
            defs.appendChild(areaGradient);
            
            // Dot gradient
            const dotGradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
            dotGradient.setAttribute('id', 'dotGradient');
            const dotStop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            dotStop1.setAttribute('offset', '0%');
            dotStop1.setAttribute('stop-color', colors.dot);
            dotStop1.setAttribute('stop-opacity', '1');
            const dotStop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            dotStop2.setAttribute('offset', '100%');
            dotStop2.setAttribute('stop-color', colors.dot);
            dotStop2.setAttribute('stop-opacity', '0.7');
            dotGradient.appendChild(dotStop1);
            dotGradient.appendChild(dotStop2);
            defs.appendChild(dotGradient);
            
            // Drop shadow filter
            const filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
            filter.setAttribute('id', 'shadow');
            const feGaussianBlur = document.createElementNS('http://www.w3.org/2000/svg', 'feGaussianBlur');
            feGaussianBlur.setAttribute('in', 'SourceAlpha');
            feGaussianBlur.setAttribute('stdDeviation', '3');
            const feOffset = document.createElementNS('http://www.w3.org/2000/svg', 'feOffset');
            feOffset.setAttribute('dx', '0');
            feOffset.setAttribute('dy', '2');
            feOffset.setAttribute('result', 'offsetblur');
            const feComponentTransfer = document.createElementNS('http://www.w3.org/2000/svg', 'feComponentTransfer');
            feComponentTransfer.setAttribute('in', 'offsetblur');
            const feFuncA = document.createElementNS('http://www.w3.org/2000/svg', 'feFuncA');
            feFuncA.setAttribute('type', 'linear');
            feFuncA.setAttribute('slope', '0.3');
            const feMerge = document.createElementNS('http://www.w3.org/2000/svg', 'feMerge');
            const feMergeNode1 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
            const feMergeNode2 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
            feMergeNode2.setAttribute('in', 'SourceGraphic');
            feMerge.appendChild(feMergeNode1);
            feMerge.appendChild(feMergeNode2);
            filter.appendChild(feGaussianBlur);
            filter.appendChild(feOffset);
            filter.appendChild(feComponentTransfer);
            feComponentTransfer.appendChild(feFuncA);
            filter.appendChild(feMerge);
            defs.appendChild(filter);
            
            svg.insertBefore(defs, svg.firstChild);
            
            // Create smooth area path - ensure zero values stay at baseline
            const smoothPath = createSmoothPath(points, baselineY);
            
            // For area, use smooth path but ensure it connects to baseline
            let areaPath = `M ${points[0].x} ${baselineY}`;
            // Use smooth path for the curve part
            const smoothPathWithoutMove = smoothPath.replace(/^M [\d.]+ [\d.]+ /, '');
            areaPath += ' ' + smoothPathWithoutMove;
            areaPath += ` L ${points[points.length - 1].x} ${baselineY} Z`;
            
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', areaPath);
            area.setAttribute('fill', 'url(#areaGradient)');
            area.style.transition = 'opacity 0.3s';
            svg.appendChild(area);
            
            // Create smooth line path
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('d', smoothPath);
            line.setAttribute('fill', 'none');
            line.setAttribute('stroke', colors.line);
            line.setAttribute('stroke-width', '3.5');
            line.setAttribute('stroke-linecap', 'round');
            line.setAttribute('stroke-linejoin', 'round');
            line.setAttribute('filter', 'url(#shadow)');
            line.style.transition = 'opacity 0.3s';
            svg.appendChild(line);
            
            // Create dots and tooltips
            const tooltip = document.createElement('div');
            tooltip.className = 'chart-tooltip';
            tooltip.id = 'chartTooltip';
            const chartParent = document.querySelector('#revenueChart').parentElement;
            if (!document.getElementById('chartTooltip')) {
                chartParent.appendChild(tooltip);
            }
            
            points.forEach((point, index) => {
                // Outer glow circle
                const glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                glow.setAttribute('cx', point.x);
                glow.setAttribute('cy', point.y);
                glow.setAttribute('r', '8');
                glow.setAttribute('fill', colors.dot);
                glow.setAttribute('opacity', '0.2');
                glow.style.transition = 'all 0.3s';
                svg.appendChild(glow);
                
                // Main dot
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '6');
                circle.setAttribute('fill', 'url(#dotGradient)');
                circle.setAttribute('stroke', 'white');
                circle.setAttribute('stroke-width', '3');
                circle.style.cursor = 'pointer';
                circle.style.transition = 'all 0.3s';
                
                circle.addEventListener('mouseenter', function(e) {
                    this.setAttribute('r', '9');
                    glow.setAttribute('r', '12');
                    glow.setAttribute('opacity', '0.4');
                    
                    const tooltipEl = document.getElementById('chartTooltip');
                    tooltipEl.innerHTML = `
                        <div style="font-weight: 700; margin-bottom: 4px;">${point.label}</div>
                        <div style="font-size: 18px; font-weight: 800; color: ${colors.line};">${formatMoney(point.value)}</div>
                    `;
                    tooltipEl.classList.add('show');
                    const rect = svg.getBoundingClientRect();
                    const parentRect = chartParent.getBoundingClientRect();
                    tooltipEl.style.left = (rect.left + point.x - parentRect.left) + 'px';
                    tooltipEl.style.top = (rect.top + point.y - parentRect.top - 50) + 'px';
                    tooltipEl.style.transform = 'translateX(-50%)';
                });
                
                circle.addEventListener('mouseleave', function() {
                    this.setAttribute('r', '6');
                    glow.setAttribute('r', '8');
                    glow.setAttribute('opacity', '0.2');
                    const tooltipEl = document.getElementById('chartTooltip');
                    tooltipEl.classList.remove('show');
                });
                
                svg.appendChild(circle);
                
                // X-axis labels
                const label = document.createElement('div');
                label.style.cssText = `
                    font-size: 12px;
                    font-weight: 600;
                    color: #64748b;
                    text-align: center;
                    flex: 1;
                    min-width: 0;
                    overflow: hidden;
                    text-overflow: ellipsis;
                `;
                label.textContent = point.label;
                labelsContainer.appendChild(label);
            });
            
            // Animate chart
            line.style.opacity = '0';
            area.style.opacity = '0';
            setTimeout(() => {
                line.style.opacity = '1';
                area.style.opacity = '1';
            }, 100);
        }

        // Load Model Statistics - Hiển thị từng sản phẩm riêng lẻ
        function loadModelStatistics() {
            const dbInstance = ensureDb();
            
            // Load products
            dbInstance.collection('products').get().then(productsSnapshot => {
                const products = [];
                
                productsSnapshot.forEach(doc => {
                    const p = doc.data();
                    if (p.deleted === true) return;
                    
                    // Extract model from ID (e.g., "SP01" -> "SP", "VAY001" -> "VAY", "DB01" -> "DB")
                    let model = 'Khác';
                    if (p.id) {
                        const match = p.id.match(/^([A-Z]+)/);
                        if (match) model = match[1];
                    } else if (p.name) {
                        const words = p.name.split(' ');
                        if (words.length > 0) model = words[0];
                    }
                    
                    const totalStock = Object.values(p.sizes || {}).reduce((acc, curr) => acc + curr, 0);
                    const importPrice = p.importPrice || 0;
                    const rentPrice = p.rentPrice || 0;
                    const rentalCount = p.rentalCount || 0;
                    const importCost = importPrice * totalStock;
                    const revenue = rentPrice * rentalCount;
                    const profit = revenue - importCost;
                    const profitPercent = importCost > 0 ? Math.round((profit / importCost) * 100) : 0;
                    
                    products.push({
                        ...p,
                        model: model,
                        totalStock: totalStock,
                        importCost: importCost,
                        revenue: revenue,
                        profit: profit,
                        profitPercent: profitPercent
                    });
                });
                
                const container = document.getElementById('modelStatsContainer');
                container.innerHTML = '';
                
                // Sort by revenue descending
                products.sort((a, b) => b.revenue - a.revenue);
                
                if (products.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">Chưa có dữ liệu</div>';
                    return;
                }
                
                products.forEach((product, index) => {
                    const isProfit = product.profit >= 0;
                    const mainImage = (product.images && Array.isArray(product.images) && product.images.length > 0)
                        ? product.images[0]
                        : (product.image || 'https://via.placeholder.com/100');
                    
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: white;
                        padding: 12px;
                        border-radius: 12px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        border: 1px solid ${isProfit ? '#d4edda' : '#f8d7da'};
                        transition: all 0.3s;
                        width: 100%;
                        box-sizing: border-box;
                        min-width: 0;
                    `;
                    card.onmouseenter = function() {
                        this.style.transform = 'translateY(-3px)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                    };
                    card.onmouseleave = function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                    };
                    
                    card.innerHTML = `
                        <div style="width: 100%; height: 100px; overflow: hidden; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                            <img src="${mainImage}" 
                                 style="width: 100%; height: 100%; object-fit: cover;" 
                                 onerror="this.src='https://via.placeholder.com/260'">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 13px; font-weight: 800; color: #333; margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${product.name || 'N/A'}
                            </div>
                            <div style="font-size: 9px; color: #999; margin-bottom: 6px;">Model: ${product.model} | ID: ${product.id || 'N/A'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Giá Vốn</div>
                                <div style="font-size: 11px; font-weight: 800; color: #333;">${formatMoney(product.importPrice || 0)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Giá Thuê</div>
                                <div style="font-size: 11px; font-weight: 800; color: #c62828;">${formatMoney(product.rentPrice || 0)}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Tồn</div>
                                <div style="font-size: 11px; font-weight: 800; color: #28a745;">${product.totalStock}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px;">
                                <div style="font-size: 9px; color: #666; margin-bottom: 3px; font-weight: 600;">Thuê</div>
                                <div style="font-size: 11px; font-weight: 800; color: #ffc107;">${product.rentalCount || 0}</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 4px; font-weight: 600;">Vốn Nhập</div>
                            <div style="font-size: 13px; font-weight: 800; color: #495057;">${formatMoney(product.importCost)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, ${isProfit ? '#d4edda' : '#f8d7da'} 0%, ${isProfit ? '#c3e6cb' : '#f5c6cb'} 100%); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid ${isProfit ? '#c3e6cb' : '#f5c6cb'};">
                            <div style="font-size: 9px; color: #666; margin-bottom: 4px; font-weight: 600;">Doanh Thu</div>
                            <div style="font-size: 13px; font-weight: 800; color: ${isProfit ? '#155724' : '#721c24'};">
                                ${formatMoney(product.revenue)}
                            </div>
                        </div>
                        <div style="background: ${isProfit ? '#d4edda' : '#f8d7da'}; padding: 8px; border-radius: 6px; border-left: 3px solid ${isProfit ? '#28a745' : '#dc3545'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 9px; color: #666; font-weight: 600;">Lãi/Lỗ:</div>
                                <div style="font-size: 13px; font-weight: 800; color: ${isProfit ? '#28a745' : '#dc3545'};">
                                    ${isProfit ? '+' : ''}${formatMoney(product.profit)}
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 9px; color: ${isProfit ? '#28a745' : '#dc3545'}; font-weight: 600; margin-top: 2px;">
                                (${isProfit ? '+' : ''}${product.profitPercent}%)
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }).catch(error => {
                console.error('Lỗi tải thống kê model:', error);
            });
        }

        // ========== ĐỒNG BỘ GOOGLE SHEETS ==========
        
        function syncToSheets() {
            if (!USE_GOOGLE_SHEETS) {
                alert('Chưa cấu hình Google Sheets! Vui lòng cấu hình trong google-sheets-config.js');
                return;
            }
            
            if (confirm('Bạn có chắc muốn đồng bộ dữ liệu từ Firebase lên Google Sheets?')) {
                syncService.syncBothWays().then((result) => {
                    const pCount = result?.products?.count ?? 0;
                    const oCount = result?.orders?.count ?? 0;
                    alert(`Đồng bộ xong!\n- Products: ${pCount} dòng\n- Orders: ${oCount} dòng\n\nMở Google Sheet để xem tab Products/Orders.`);
                    loadDashboard();
                }).catch(error => {
                    console.error('Lỗi đồng bộ:', error);
                    alert('Có lỗi xảy ra khi đồng bộ!\n' + (error?.message || error));
                });
            }
        }

        function syncFromSheets() {
            if (!USE_GOOGLE_SHEETS) {
                alert('Chưa cấu hình Google Sheets! Vui lòng cấu hình trong google-sheets-config.js');
                return;
            }
            
            if (confirm('Bạn có chắc muốn đồng bộ dữ liệu từ Google Sheets về Firebase? Dữ liệu hiện tại có thể bị ghi đè!')) {
                syncService.syncProductsFromSheet().then((result) => {
                    const count = result?.count ?? 0;
                    alert(`Đồng bộ xong!\n- Imported Products: ${count} dòng`);
                    loadProducts();
                    loadDashboard();
                }).catch(error => {
                    console.error('Lỗi đồng bộ:', error);
                    alert('Có lỗi xảy ra khi đồng bộ!\n' + (error?.message || error));
                });
            }
        }

        function openGoogleSheet() {
            try {
                const cfg = (typeof GOOGLE_SHEETS_CONFIG !== 'undefined' ? GOOGLE_SHEETS_CONFIG : (window && window.GOOGLE_SHEETS_CONFIG));
                if (!cfg || !cfg.SHEET_ID) {
                    alert('Chưa có SHEET_ID. Vui lòng cấu hình trong google-sheets-config.js');
                    return;
                }
                const url = `https://docs.google.com/spreadsheets/d/${cfg.SHEET_ID}/edit`;
                window.open(url, '_blank', 'noopener,noreferrer');
            } catch (e) {
                console.error(e);
                alert('Không mở được Google Sheet. Vui lòng kiểm tra cấu hình.');
            }
        }

        async function checkGoogleSheetData() {
            try {
                if (!USE_GOOGLE_SHEETS) {
                    alert('USE_GOOGLE_SHEETS đang tắt. Vui lòng cấu hình trong google-sheets-config.js');
                    return;
                }
                const cfg = (typeof GOOGLE_SHEETS_CONFIG !== 'undefined' ? GOOGLE_SHEETS_CONFIG : (window && window.GOOGLE_SHEETS_CONFIG));
                if (!cfg || !cfg.SHEET_ID) {
                    alert('Chưa có SHEET_ID. Vui lòng cấu hình trong google-sheets-config.js');
                    return;
                }

                // Optional info endpoint (newer Apps Script)
                let infoText = '';
                try {
                    if (cfg.WEB_APP_URL) {
                        const info = await syncService.getWebAppInfo();
                        infoText = `\nWebApp info: ${JSON.stringify(info)}`;
                    }
                } catch (_) {
                    // ignore
                }

                const products = await syncService.readFromSheet(cfg.SHEETS.PRODUCTS);
                const orders = await syncService.readFromSheet(cfg.SHEETS.ORDERS);

                const pRows = Math.max(0, (products?.length || 0) - 1); // minus header
                const oRows = Math.max(0, (orders?.length || 0) - 1);

                alert(
                    `Google Sheet OK\n` +
                    `- SHEET_ID: ${cfg.SHEET_ID}\n` +
                    `- Tab Products: ${pRows} dòng\n` +
                    `- Tab Orders: ${oRows} dòng` +
                    infoText
                );
            } catch (e) {
                console.error(e);
                alert('Không đọc được dữ liệu từ Google Sheet.\n' + (e?.message || e));
            }
        }

        // Initialize
        checkAuth();
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            restoreActiveTab();
        }
    </script>
</body>
</html>


