<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Giao H√†ng A4 - Trang Ph·ª•c Bi·ªÉu Di·ªÖn Nh·ªõ V≈©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Firebase (Compat SDK) - required for `firebase-config.js` to create `db` -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e5e7eb; /* M√†u n·ªÅn x√°m nh·∫°t cho body */
        }
        .font-calligraphy {
            font-family: 'Dancing Script', cursive;
        }
        .a4-container {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 1rem auto;
            border-radius: 0.5rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background: white;
        }
        .input-field {
            border-bottom: 1px dotted #000;
            padding: 2px 4px;
            background-color: transparent;
        }
        .input-field:focus {
            outline: none;
            border-bottom: 1px solid #000;
        }
        .table-cell {
            border: 1px solid #000;
            padding: 6px;
            text-align: center;
        }
        .header-cell {
            border: 1px solid #000;
            padding: 6px;
            text-align: center;
            font-weight: bold;
            background-color: #f3f4f6;
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
            }
            .no-print {
                display: none !important;
            }
            .delete-row-btn,
            .table-cell.no-print,
            th.no-print {
                display: none !important;
            }
            .a4-container {
                margin: 0;
                box-shadow: none;
                border-radius: 0;
                padding: 10mm; /* Gi·∫£m padding khi in ƒë·ªÉ v·ª´a l·ªÅ */
            }
            body, .print-text-base {
                font-size: 10pt;
            }
            .print-text-sm {
                 font-size: 9pt;
            }
            .print-text-xs {
                 font-size: 8pt;
            }
            .print-header-main {
                font-size: 32pt !important;
            }
            .print-header-sub {
                font-size: 16pt !important;
            }
        }
    </style>
</head>
<body>
    <!-- Status / errors (hidden when printing) -->
    <div id="loadStatus" class="no-print" style="max-width: 210mm; margin: 0 auto 10px; padding: 10px 12px; border-radius: 8px; background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; display: none;"></div>

    <div class="a4-container">
        <!-- Header -->
        <header class="grid grid-cols-[1fr_auto_1fr] items-center gap-x-4 mb-4 pb-3 border-b">
            <!-- Left: Logo -->
            <div class="justify-self-start">
                 <!-- SVG Logo Hoa Sen C√°ch ƒêi·ªáu v·ªõi B√†n Tay -->
                <svg viewBox="0 0 200 200" class="w-28 h-28 object-contain">
                    <g>
                        <!-- Hands (Green) - Styled to look like they are lifting -->
                        <path d="M 20,150 C 40,100 85,90 95,140 C 65,150 35,155 20,150 Z" fill="#5eead4" stroke="#2dd4bf" stroke-width="0.5" />
                        <path d="M 180,150 C 160,100 115,90 105,140 C 135,150 165,155 180,150 Z" fill="#5eead4" stroke="#2dd4bf" stroke-width="0.5" />

                        <!-- Lotus Petals (Pink) - Bigger and higher -->
                        <path d="M 100,30 C 70,55 60,105 100,135 C 140,105 130,55 100,30 Z" fill="#f9a8d4" />
                        <path d="M 75,45 C 50,65 50,105 80,130 C 75,95 65,65 75,45 Z" fill="#f472b6" />
                        <path d="M 125,45 C 150,65 150,105 120,130 C 125,95 135,65 125,45 Z" fill="#f472b6" />
                        <path d="M 100,60 C 85,80 80,110 100,128 C 120,110 115,80 100,60 Z" fill="#ec4899" />
                        <path d="M 88,70 C 78,85 78,110 93,125 C 88,105 83,85 88,70 Z" fill="#db2777" />
                        <path d="M 112,70 C 122,85 122,110 107,125 C 112,105 117,85 112,70 Z" fill="#db2777" />
                        <circle cx="100" cy="110" r="6" fill="#fdf2f8" />

                        <!-- Text -->
                        <text x="100" y="185" text-anchor="middle" font-family="Dancing Script, cursive" font-size="22" fill="#0d9488" font-weight="bold">
                            Trang Ph·ª•c Nh·ªõ V≈©
                        </text>
                    </g>
                </svg>
            </div>
            <!-- Shop Info -->
            <div class="text-center">
                <h1 class="font-calligraphy text-5xl font-bold bg-gradient-to-r from-yellow-500 to-red-600 text-transparent bg-clip-text print-header-main whitespace-nowrap">Trang Ph·ª•c Nh·ªõ V≈©</h1>
                <p class="text-xs mt-2 print-text-sm">VPDD: 99/5/4 Hu·ª≥nh VƒÉn Ngh·ªá, P. An H·ªôi T√¢y, TP HCM</p>
                <p class="text-xs mt-1 print-text-sm">ƒê·ªãa ch·ªâ c≈©: 99/5/4 Hu·ª≥nh VƒÉn Ngh·ªá, Ph∆∞·ªùng 12, Qu·∫≠n G√≤ V·∫•p, TP HCM</p>
                <p class="text-xs mt-1 print-text-sm">SƒêT/ZALO: 0986682494</p>
            </div>
            <!-- Right: Bank Info & QR -->
            <div class="flex-shrink-0 text-right text-xs justify-self-end print-text-sm">
                 <img src="https://img.vietqr.io/image/MB-0986682494-compact.png" alt="M√£ QR Chuy·ªÉn kho·∫£n" class="w-28 h-28 object-contain border rounded p-1 bg-white shadow-sm ml-auto">
                 <p class="font-semibold mt-2">V≈® TH·ªä NH·ªö - MB Bank</p>
                 <p>STK: 0986682494</p>
            </div>
        </header>

        <!-- Title -->
        <h2 class="text-2xl font-bold text-center mb-6 uppercase print-header-sub">Phi·∫øu Giao H√†ng</h2>

        <!-- Customer Info -->
        <section class="grid grid-cols-2 gap-x-6 gap-y-3 mb-5 print-text-base">
            <div class="flex items-center">
                <label class="font-semibold w-32">T√™n kh√°ch h√†ng:</label>
                <input type="text" id="customer-name" class="input-field flex-grow">
            </div>
            <div class="flex items-center">
                <label class="font-semibold w-20">ƒêi·ªán tho·∫°i:</label>
                <input type="text" id="customer-phone" class="input-field flex-grow">
            </div>
            <div class="flex items-center col-span-2">
                 <label class="font-semibold w-32">ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="customer-address" class="input-field flex-grow">
            </div>
        </section>
        
        <!-- Items Table -->
        <section class="mb-5">
            <table class="w-full border-collapse print-text-base" id="items-table">
                <thead>
                    <tr>
                        <th class="header-cell" style="width: 5%;">STT</th>
                        <th class="header-cell" style="width: 40%;">T√äN S·∫¢N PH·∫®M</th>
                        <th class="header-cell" style="width: 10%;">S·ªê L∆Ø·ª¢NG</th>
                        <th class="header-cell" style="width: 15%;">ƒê∆†N GI√Å</th>
                        <th class="header-cell" style="width: 15%;">T·ªîNG TI·ªÄN</th>
                        <th class="header-cell" style="width: 10%;">GHI CH√ö</th>
                        <th class="header-cell no-print" style="width: 5%;">X√ìA</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS will generate rows here -->
                </tbody>
            </table>
             <button id="addRowBtn" class="no-print mt-3 px-3 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 focus:outline-none">
                Th√™m d√≤ng
            </button>
        </section>

        <!-- Summary -->
        <section class="grid grid-cols-2 gap-x-6 mb-5 print-text-base">
            <div class="space-y-2">
                <div class="flex items-center">
                    <label class="font-semibold w-36">Ng√†y thu√™:</label>
                    <input type="text" id="rental-date" class="input-field flex-grow" placeholder="dd/mm/yyyy">
                </div>
                <div class="flex items-center">
                    <label class="font-semibold w-36">Ng√†y tr·∫£:</label>
                    <input type="text" id="return-date" class="input-field flex-grow" placeholder="Tr∆∞·ªõc hh:mm dd/mm/yyyy">
                </div>
                 <div class="flex items-center">
                    <label class="font-semibold w-36">Ng∆∞·ªùi l·∫≠p phi·∫øu:</label>
                    <input type="text" id="invoice-creator" class="input-field flex-grow">
                </div>
            </div>
            <div class="relative">
                 <div class="grid grid-cols-[1fr_auto] items-center gap-y-2">
                    <label class="font-bold text-base text-right pr-4">T·ªîNG C·ªòNG:</label>
                    <span id="grand-total" class="font-bold text-base w-36 text-right pr-2">0</span>
                    
                    <label class="font-semibold text-right pr-4">Ti·ªÅn c·ªçc:</label>
                    <input type="text" class="input-field w-36 text-right" id="deposit-amount" value="0">

                    <label class="font-semibold text-right pr-4 whitespace-nowrap">C√≤n l·∫°i c·∫ßn TT:</label>
                    <span id="remaining-amount" class="font-bold text-base w-36 text-right pr-2">0</span>
                </div>
                <!-- Stamp -->
                <div class="absolute top-full left-1/2 transform -translate-x-1/4 translate-y-2 -rotate-12 opacity-90 print:opacity-100">
                    <div class="border-4 border-red-600 rounded-md py-2 px-4 text-red-600 text-center font-bold text-xs leading-tight uppercase tracking-wider">
                        <p class="whitespace-nowrap">Chuy√™n may b√°n v√† cho thu√™</p>
                        <p class="whitespace-nowrap">Trang ph·ª•c m·∫ßm non Nh·ªõ V≈©</p>
                        <p class="whitespace-nowrap">ƒêT: 0986682494</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Notes -->
        <section class="mt-6 pt-3 border-t border-dashed print-text-sm text-gray-700">
            <h4 class="font-bold mb-1">L∆∞u √Ω:</h4>
            <ul class="list-disc list-inside space-y-1">
                <li>Qu√Ω kh√°ch g·ª≠i tr·∫£ trang ph·ª•c tr·ªÖ 1 ng√†y ph√°t sinh th√™m 30% t·ªïng bill.</li>
                <li>Qu√Ω kh√°ch book ship tr·∫£ ƒë·ªì sau gi·ªù h√†nh ch√≠nh (17h00 ) Shop s·∫Ω x·ª≠ l√Ω ki·ªÉm v√† ho√†n ƒë∆°n sang ng√†y h√¥m sau.</li>
                <li>Qu√Ω kh√°ch book ship G·ª¨I - TR·∫¢ ƒë·ªì vui l√≤ng thanh to√°n ph√≠ ship v√† g·ª≠i k√®m ho√° ƒë∆°n ( Shop nh·∫≠n tr√°nh nh·∫ßm l·∫´n h√†ng c·ªßa kh√°ch kh√°c ).</li>
            </ul>
        </section>
        
        <!-- Footer -->
        <footer class="text-center mt-6 print-text-base">
            <p class="font-bold">TRANG PH·ª§C BI·ªÇU DI·ªÑN NH·ªö V≈®</p>
            <p class="italic">CH√ÇN TH√ÄNH C·∫¢M ∆†N V√Ä K√çNH CH√öC S·ª®C KH·ªéE!</p>
        </footer>
    </div>

    <div class="text-center my-6 no-print">
        <button onclick="window.print()" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
            üñ®Ô∏è In Phi·∫øu
        </button>
    </div>

    <script>
        const tableBody = document.querySelector('#items-table tbody');
        const addRowBtn = document.getElementById('addRowBtn');
        const loadStatusEl = document.getElementById('loadStatus');

        let rowCount = 0;

        const formatCurrency = (value) => new Intl.NumberFormat('vi-VN').format(value || 0);
        const parseCurrency = (value) => Number(String(value).replace(/[^0-9]/g, '')) || 0;

        function setLoadStatus(message, type = 'warn') {
            if (!loadStatusEl) return;
            if (!message) {
                loadStatusEl.style.display = 'none';
                loadStatusEl.textContent = '';
                return;
            }
            const styles = {
                info: { bg: '#e7f1ff', border: '#b6d4fe', color: '#084298' },
                warn: { bg: '#fff3cd', border: '#ffecb5', color: '#664d03' },
                error: { bg: '#f8d7da', border: '#f5c2c7', color: '#842029' },
                ok: { bg: '#d1e7dd', border: '#badbcc', color: '#0f5132' }
            };
            const s = styles[type] || styles.warn;
            loadStatusEl.style.display = 'block';
            loadStatusEl.style.background = s.bg;
            loadStatusEl.style.borderColor = s.border;
            loadStatusEl.style.color = s.color;
            loadStatusEl.textContent = message;
        }
        
        const updateRowNumbers = () => {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        };

        const createRow = () => {
            rowCount++;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="table-cell">${rowCount}</td>
                <td class="table-cell"><input type="text" class="w-full text-left p-1 focus:outline-none bg-transparent"></td>
                <td class="table-cell"><input type="number" class="w-16 text-center p-1 focus:outline-none quantity bg-transparent" value="1" min="0"></td>
                <td class="table-cell"><input type="text" class="w-full text-right p-1 focus:outline-none unit-price bg-transparent" value="0"></td>
                <td class="table-cell text-right font-semibold px-2 py-1 total">0</td>
                <td class="table-cell"><input type="text" class="w-full text-left p-1 focus:outline-none bg-transparent"></td>
                <td class="table-cell no-print">
                    <button class="delete-row-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 focus:outline-none" onclick="deleteRow(this)">
                        <i class="fas fa-trash"></i> X√≥a
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        };

        const deleteRow = (btn) => {
            const row = btn.closest('tr');
            if (row && tableBody.querySelectorAll('tr').length > 1) {
                row.remove();
                updateRowNumbers();
                calculateTotals();
            } else {
                alert('Ph·∫£i c√≥ √≠t nh·∫•t 1 d√≤ng trong b·∫£ng!');
            }
        };

        const calculateFinalPayment = () => {
            const grandTotal = parseCurrency(document.getElementById('grand-total').textContent);
            const depositAmount = parseCurrency(document.getElementById('deposit-amount').value);
            const remaining = grandTotal - depositAmount;
            document.getElementById('remaining-amount').textContent = formatCurrency(remaining > 0 ? remaining : 0);
        };

        const calculateTotals = () => {
            let grandTotal = 0;
            tableBody.querySelectorAll('tr').forEach(row => {
                const quantity = parseInt(row.querySelector('.quantity').value) || 0;
                const unitPrice = parseCurrency(row.querySelector('.unit-price').value);
                
                const total = quantity * unitPrice;
                
                row.querySelector('.total').textContent = formatCurrency(total);
                grandTotal += total;
            });
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            calculateFinalPayment();
        };

        tableBody.addEventListener('input', (e) => {
            if (e.target.matches('.quantity') || e.target.matches('.unit-price')) {
                calculateTotals();
            }
        });

        tableBody.addEventListener('focusout', (e) => {
            if(e.target.classList.contains('unit-price')){
                e.target.value = formatCurrency(parseCurrency(e.target.value));
                calculateTotals();
            }
        });

        const depositEl = document.getElementById('deposit-amount');
        depositEl.addEventListener('input', () => calculateFinalPayment());
        depositEl.addEventListener('focusout', e => {
            e.target.value = formatCurrency(parseCurrency(e.target.value));
            calculateFinalPayment();
        });

        addRowBtn.addEventListener('click', createRow);

        // Initial rows
        for(let i = 0; i < 8; i++) {
            createRow();
        }

        function getOrderId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('orderId') || localStorage.getItem('currentOrderId') || '';
        }

        function getLocalOrder() {
            try {
                return JSON.parse(localStorage.getItem('currentOrder') || '{}') || {};
            } catch (e) {
                return {};
            }
        }

        async function getDbSafe() {
            if (typeof waitForDb === 'function') return await waitForDb();
            if (typeof db !== 'undefined' && db) return db;
            if (typeof window !== 'undefined' && window.db) return window.db;
            throw new Error('Firebase db ch∆∞a s·∫µn s√†ng');
        }

        async function loadOrderData() {
            const orderId = getOrderId();
            const localOrder = getLocalOrder();

            if (orderId) {
                setLoadStatus(`ƒêang t·∫£i ƒë∆°n h√†ng ${orderId} t·ª´ Firebase...`, 'info');
                try {
                    const dbInstance = await getDbSafe();
                    const doc = await dbInstance.collection('orders').doc(orderId).get();
                    if (doc.exists) {
                        const order = { id: doc.id, ...doc.data() };
                        fillInvoice(order);
                        setLoadStatus('', 'ok');
                        return;
                    }

                    if (localOrder.items && localOrder.items.length > 0) {
                        fillInvoice(localOrder);
                        setLoadStatus('Kh√¥ng t√¨m th·∫•y ƒë∆°n tr√™n Firebase, ƒëang d√πng d·ªØ li·ªáu t·∫°m (localStorage).', 'warn');
                        return;
                    }

                    setLoadStatus('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra l·∫°i m√£ ƒë∆°n ho·∫∑c t·∫°o ƒë∆°n t·ª´ trang ch·ªß.', 'error');
                    return;
                } catch (error) {
                    console.error('L·ªói t·∫£i ƒë∆°n h√†ng:', error);
                    if (localOrder.items && localOrder.items.length > 0) {
                        fillInvoice(localOrder);
                        setLoadStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c t·ª´ Firebase, ƒëang d√πng d·ªØ li·ªáu t·∫°m (localStorage).', 'warn');
                        return;
                    }
                    setLoadStatus('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Firebase ƒë·ªÉ t·∫£i ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra m·∫°ng/c·∫•u h√¨nh Firebase.', 'error');
                    return;
                }
            }

            if (localOrder.items && localOrder.items.length > 0) {
                fillInvoice(localOrder);
                setLoadStatus('', 'ok');
                return;
            }

            setLoadStatus('Ch∆∞a c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n. H√£y t·∫°o ƒë∆°n t·ª´ trang ch·ªß ho·∫∑c m·ªü t·ª´ Admin (In H√≥a ƒê∆°n).', 'warn');
        }

        function fillInvoice(order) {
            // ƒêi·ªÅn th√¥ng tin kh√°ch h√†ng
            document.getElementById('customer-name').value = order.customerName || '';
            document.getElementById('customer-phone').value = order.customerPhone || '';
            document.getElementById('customer-address').value = order.customerAddress || '';

            // X√≥a c√°c d√≤ng m·∫∑c ƒë·ªãnh
            tableBody.innerHTML = '';
            rowCount = 0;

            // Th√™m c√°c s·∫£n ph·∫©m t·ª´ ƒë∆°n h√†ng
            if (order.items && order.items.length > 0) {
                order.items.forEach((item) => {
                    rowCount++;
                    const row = document.createElement('tr');
                    const itemPrice = typeof item.price === 'number' ? item.price : parseCurrency(item.price);
                    const itemQuantity = typeof item.quantity === 'number' ? item.quantity : parseInt(item.quantity) || 1;
                    row.innerHTML = `
                        <td class="table-cell">${rowCount}</td>
                        <td class="table-cell"><input type="text" class="w-full text-left p-1 focus:outline-none bg-transparent" value="${item.name || ''}" readonly></td>
                        <td class="table-cell"><input type="number" class="w-16 text-center p-1 focus:outline-none quantity bg-transparent" value="${itemQuantity}" min="0"></td>
                        <td class="table-cell"><input type="text" class="w-full text-right p-1 focus:outline-none unit-price bg-transparent" value="${formatCurrency(itemPrice)}"></td>
                        <td class="table-cell text-right font-semibold px-2 py-1 total">${formatCurrency(itemPrice * itemQuantity)}</td>
                        <td class="table-cell"><input type="text" class="w-full text-left p-1 focus:outline-none bg-transparent" value="${item.note || order.notes || ''}"></td>
                        <td class="table-cell no-print">
                            <button class="delete-row-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 focus:outline-none" onclick="deleteRow(this)">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // T√≠nh t·ªïng
            calculateTotals();

            // ƒêi·ªÅn ng√†y thu√™
            if (order.rentalDate) {
                let date;
                if (order.rentalDate.seconds) {
                    date = new Date(order.rentalDate.seconds * 1000);
                } else if (order.rentalDate instanceof Date) {
                    date = order.rentalDate;
                } else {
                    date = new Date(order.rentalDate);
                }
                document.getElementById('rental-date').value = formatDateVN(date);
            } else {
                document.getElementById('rental-date').value = formatDateVN(new Date());
            }

            // ƒêi·ªÅn ng√†y tr·∫£
            if (order.returnDate) {
                let returnDate;
                if (order.returnDate.seconds) {
                    returnDate = new Date(order.returnDate.seconds * 1000);
                } else if (order.returnDate instanceof Date) {
                    returnDate = order.returnDate;
                } else {
                    returnDate = new Date(order.returnDate);
                }
                document.getElementById('return-date').value = `Tr∆∞·ªõc 17:00 ${formatDateVN(returnDate)}`;
            }

            // Ng∆∞·ªùi l·∫≠p phi·∫øu
            if (order.creator) {
                document.getElementById('invoice-creator').value = order.creator;
            }
        }

        function formatDateVN(date) {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadOrderData();
        });
    </script>
</body>
</html>
